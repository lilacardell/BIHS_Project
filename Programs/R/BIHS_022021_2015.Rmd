---
title: "BIHS_explore"
author: "Lila Cardell"
date: "February 18, 2021"
output: pdf_document
#fontsize: 11pt

#bibliography: nutrition.bibtex
---

Set working directory and install packages
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,root.dir='/Users/juli/Desktop/BIHS/master/BIHS_Project ',warning = FALSE, message=FALSE)
options(scipen=999)
set.seed(12345)
###  Check for and load Packages   ###
#library(installr)
#updateR()
# ## get packages installed
# packs = as.data.frame(installed.packages(.libPaths()[1]), stringsAsFactors = F)
# 
# ## and now re-install install packages using install.packages()
# install.packages(packs$Package)

## Clear worksace
rm(list = ls())
gc()

#writeLines('PATH="${RTOOLS40_HOME}\\usr\\bin;${PATH}"', con = "~/.Renviron")

## This function will check if a package is installed, and if not, install it
pkgTest  =  function(x) {
  if (!require(x, character.only = TRUE))
  {
    install.packages(x, dep = TRUE)
    if(!require(x, character.only = TRUE)) stop("Package not found")
  }
}

## These lines load the required packages
packages  =  c('data.table','tidyverse','haven','stargazer','plm','lubridate','survey','psych','knitr','xtable','tables','kableExtra','fuzzyjoin','MASS','matrixcalc','car','stringr','styler','readxl','magrittr','sjmisc','readxl','srvyr','gdata','labelled')

#,) ## you can add more packages here
lapply(packages, pkgTest)




```



1. Import BIHS data
```{r import BIHS data,results='hide'}
# Read in data for project

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data")

#this pulls in all 2015 household level files except the WEAI
filenames<-grep(list.files(path="./Raw Data/bihs_2015/household/data"),pattern=c("weai","h"),inv=TRUE,value=TRUE)
names<-gsub(".dta","",filenames)

 for(i in names){
   filepath <- file.path(paste("./Raw Data/bihs_2015/household/data/",i,".dta",sep=""))
   if (i == "003_r2_male_mod_b1") {
     assign(paste("b1_male_2015"),haven::read_dta(filepath))
   }
   assign(paste(substring(i,12),"_2015",sep=""),haven::read_dta(filepath))
 }

#task(completed): inputagain "_mod_b1_2015" and rename to "b1_male_2015"


#read in the 2015 census and 2015 consumption file for now
#census_2015 = read_dta("./Raw Data/bihs_2015_2012/census/data/001_census_ftf.dta")

#x1_1_f_2015 = read_dta("./Raw Data/bihs_2015/household/data/064_r2_mod_x1_1_female.dta")




#import names of menu items from the 2015 codebook
#this is assumed to be more comprehensize than 2015 and also available in excel
menucodes = read_excel("./Raw Data/bihs_2015/household/documents/000_codebook.xls", 
                       sheet = "064_r2_mod_x1_1_female", range = "C31:D415",col_names = c("menuname","menu"))

# task - aggregate `x1_1` `x1_2`

#count menu items

# task - rename x1_05 -> menu select the first 41 columns(drop the last one)
# rename x1_2 table x1_05 ->menu
x1_1_female_2015 = x1_1_female_2015 %>% 
                  rename(menu = x1_05) %>% 
                  select(1:41)
x1_2_female_2015 = x1_2_female_2015 %>% rename(menu = x1_05)
# task - aggregate `x1_1` `x1_2` to `x1_female_2015`
x1_female_2015 = rbind(x1_1_female_2015, x1_2_female_2015)

menu_items = aggregate(a01~menu, data=x1_female_2015, FUN = length)%>%
  left_join(menucodes,by=c("menu"))%>%
dplyr::rename("menucode"="menu","hh_num" = "a01")%>%
  arrange(desc(hh_num))
#206 items consumed in 2015
#issue with salt not being separated into iodine/non-iodine in 2015
#menu_items = aggregate(a01~x1_05, data=x1_1_f_2015, FUN = length) #180 items consumed in 2015
#1/3 salt is regular, 2/3 iodine (return to this later)


###import names of ingredient items from 2015 (assumed to be more comprehensize than 2015)
ingredientcodes = read_excel("./Raw Data/bihs_2015/household/documents/000_codebook.xls", 
                             sheet = "064_r2_mod_x1_1_female", range = "C417:D717", col_names =c("ingredientname","ingredient"))%>%
 add_row(ingredientname="Salt",ingredient=252)

occupationcodes=read_excel("./Raw Data/bihs_2015/household/documents/000_codebook.xls", 
                             sheet ="003_r2_male_mod_b1", range = "C106:D182", col_names = c("occupation_name","occupation_code"))




rm(filenames,filepath,i,names,x1_1_f_2015)

```

2. Import FCT Data
```{r import FCT Data,results='hide'}

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient tables")
###Import nutrition data
FCT_Bangladesh =read_excel("./FCDB_7_4_14_LC.xlsx",sheet = "UserDB_Main_table")%>% 
dplyr::select(2,3,8,11:13,16,17)%>% 
 dplyr::rename(name=2,kcal=3,protein=4,fat=5,carb=6,calcium=7,iron=8)%>%
  filter(!is.na(BIHS_code))%>%
   mutate_at(vars(1,3:8),as.numeric,na.omit=TRUE)


FCT_India=read_excel("./ifct2017_compositions.xlsx",sheet = "Data")%>% 
  dplyr::select(1,3,enerc,protcnt,fatce,choavldf,ca,fe)%>% 
  dplyr::rename(kj=3,protein=4,fat=5,carb=6,calcium=7,iron=8)%>%
  filter(!is.na(BIHS_code))%>%
   mutate_at(vars(1,3:8),as.numeric,na.omit=TRUE)%>%
  mutate(kcal=kj/4.184)%>%
  dplyr::select(BIHS_code,name,kcal,protein,fat,carb,calcium,iron)

#FCT_B=anti_join(FCT_Bangladesh,FCT_India,by=c("BIHS_code"))%>%
 #  mutate_at(vars(1,3:8),as.numeric,na.omit=TRUE)

FCT_all=bind_rows(FCT_India,FCT_Bangladesh)%>%
  arrange(BIHS_code)%>%
  dplyr::select(-name)%>%
  group_by(BIHS_code)%>%
  dplyr::summarise_all(max)

nutrients = left_join(ingredientcodes,FCT_all,by=c("ingredient"="BIHS_code"))


rm(FCT_Bangladesh,FCT_India,FCT_all)

```


3. Calculate calories for each recipe
```{r calculate recipe calories}

#task(completed):  line 165: cwgt does not exist, changed to "x1_09"
#task(completed): reorder columns of x1_female_2015 : move "hh_type"to the end
x1_female_2015 <- x1_female_2015[,c(1,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,2)]

#join recipe dataset with menucodes to include menu names
x1_f_2015_m = left_join(x1_female_2015,menucodes,by=c("menu"))%>%
  mutate(date=as_date(paste(x1_yy, x1_mm, x1_dd,sep="-")))%>%
  dplyr::rename(rid=x1_rid,time=x1_03,menucode=menu,foodsource=x1_02,menucookwt=x1_09)%>%
  dplyr::select("a01","hh_type","rid","date","time","foodsource","menucode","menuname","menucookwt",contains("x1_07"),contains("x1_08"))%>%
  filter(!menucode %in% c(252,2521,2522))

#rename variables with ingredient codes and weights to help with reshaping dataset 
names(x1_f_2015_m)<-gsub("x1_07","icode",names(x1_f_2015_m))
names(x1_f_2015_m)<-gsub("x1_08","iweight",names(x1_f_2015_m))
names(x1_f_2015_m)<-gsub("_0","_",names(x1_f_2015_m))


#reshape the recipe dataset to join it with the nutrient dataset
#edit codes ingredients which have two BIHS codes, but are the same thing

nutnames=names(dplyr::select(nutrients,3:8))



recipes=melt(setDT(x1_f_2015_m),measure.vars=patterns("icode","iweight"),variable.name="inumber",value.name=c("icode","iweight"))%>%
  arrange(a01,date,time,menucode)%>%
  filter(is.finite(icode))%>%
  mutate_at(.vars=vars(contains("code")),.funs=list(~recode(.,"14=10;90=80;93=92;95=94;103=157;107=998;108=157;110=157;112=157;115=157;126=123;185=215;187=186;188=189;193=181;204=179;211=179;212=999;217=222;218=226;227=2287;229=228;233=232;235=213;237=189;238=189;243=242;246=999;247=999;253=999;256=999;257=999;261=260;267=162;269=999;305=3121;310=309;311=3121;314=999;905=998;908=189;902=997;909=213;1323=132;1421=142;1422=142;2521=252;2522=252;2886=2885;2876=2873;2896=2894;2781=278;2782=278")))%>%
  mutate_at(.vars=vars(contains("code")),.funs=list(~as.numeric(.)))%>%
  left_join(nutrients,by=c("icode"="ingredient"))

#library(plyr)
# mutate(across(c("menucode","icode"),~as.numeric(.)))%>%
# mutate(across(c("menucode","icode"),~plyr::revalue(.,c("14"="10","90"="80","93=92","95=94","103=157","107=998","108=157","110=157","112=157","115=157","126=123","185=215","187=186","188=189","193=181","204=179","211=195","212=999","217=222","218=226","227=2287","229=228","233=232","235=213","237=189","238=189","243=242","246=999","247=999","253=999","256=999","257=999","261=260","267=162","269=999","305=312","310=309","311=312","314=999","905=998","908=189","902=997","909=213","1323=132","1421=142","1422=142","2521=252","2522=252","2886=2885","2876=2873","2896=2894","2781=278","2782=278"))))%>%left_join(nutrients,by=c("icode"="ingredient"))



#calculate the specific per gram nutrient input of each ingredient: nutrient_c = (ingredient weight in grams x nutrientval per 100g)/100
for (x in nutnames){
 recipes[[paste(x,"c",sep="_")]]<-recipes[[x]]*recipes$iweight/100
}


#investigate ingredients that are missing nutrient info
missing = recipes[is.na(recipes$kcal),]
missing_ingredients = aggregate(a01~icode+ingredientname, data=missing, FUN = length) %>%
  arrange(desc(a01))

#sum nutrients over meal
recipe_sum=recipes%>%
  group_by(a01,hh_type,rid,date,time,foodsource,menucode,menuname,menucookwt)%>%
 dplyr::summarise_at(vars(iweight,contains("_c")),sum,na.rm=TRUE)%>%
  dplyr::rename_at(.vars=vars(contains("_c")),.funs=funs(sub("_c","",.)))
  
#find the median and 5% and 95% percentile per gram nutrient info for each meal
p <- c(.05,.5,.95)
p_names <- paste0(p*100, "%")
p_funs <- map(p, ~partial(quantile, probs = .x, na.rm = TRUE)) %>% 
  set_names(nm = p_names)

recipe_med=recipe_sum%>%
  mutate(across(kcal:iron,~./iweight,na.rm=TRUE))%>%
filter(kcal>0)%>%
  group_by(menucode)%>%
dplyr::summarise(across(kcal:iron,p_funs))
    

#add the median per gram nutrient info back into the recipe set and replace missing items with median and winsorize at 5%
recipe_hh=left_join(recipe_sum,recipe_med,by=c("menucode"))

for (x in nutnames){
recipe_hh[[x]]=if_else(recipe_hh[[x]]==0|is.nan(recipe_hh[[x]])|is.na(recipe_hh[[x]]),recipe_hh[[paste(x,"50%",sep="_")]]*recipe_hh$iweight,
                       if_else(recipe_hh[[x]]>recipe_hh[[paste(x,"95%",sep="_")]],recipe_hh[[paste(x,"95%",sep="_")]]*recipe_hh$iweight,
                        if_else(recipe_hh[[x]]<recipe_hh[[paste(x,"5%",sep="_")]],recipe_hh[[paste(x,"5%",sep="_")]]*recipe_hh$iweight,
                                recipe_hh[[x]])))
}


recipe_hh=recipe_hh%>%
dplyr::select(1:16)%>%
 dplyr::rename_at(.vars=vars(10:16),.funs=funs(paste("sum",.,sep="_")))



#investigate recipes that are still missing nutrient info
missing = recipe_hh[is.na(recipe_hh$sum_kcal),]
missing_recipes = aggregate(a01~menucode+menuname, data=missing, FUN = length) %>%
  arrange(desc(a01))

#rematch again for recipes that are actually ingredients
recipe_hh=left_join(recipe_hh,nutrients,by=c("menucode"="ingredient"))

for (x in nutnames){
recipe_hh[[paste("sum",x,sep="_")]]=if_else(recipe_hh[[paste("sum",x,sep="_")]]==0|is.na(recipe_hh[[paste("sum",x,sep="_")]]),
                                    recipe_hh[[x]]*recipe_hh$sum_iweight, recipe_hh[[paste("sum",x,sep="_")]])
}

#check again for missing 
#investigate recipes that are still missing nutrient info
missing = recipe_hh[is.na(recipe_hh$sum_kcal),]
missing_recipes = aggregate(a01~menucode+menuname, data=missing, FUN = length) %>%
  arrange(desc(a01))


rm(recipe_med,recipe_sum,recipes,menucodes,nutrients,missing,x1_female_2015,x1_f_2015_m,x,menu_items,ingredientcodes,missing_ingredients,missing_recipes,p,p_funs,p_names)
```

4. Calculate calories consumed by each individual
```{r calculate individual calories,results='hide'}
#integrate with individual consumption data set and create individual calorie consumption

# #flag for individuals without consumption data
# datacheck = x2_f_2015  %>%
#   group_by(a01,x2_01) %>%
#   summarise(mealdata = n())%>%
#   filter(x2_01<100)%>%
#   dplyr::rename(mid=x2_01)

#task(completed): delete columns "sex""age"mem_stat""flag_x2" in x2_1_female_2015
#task(completed): combine x2_1_female_2015 and x2_1_female_2015 to x2_female_2015
#task(completed): move "hh_type" in x2_female_2015 to the end
x2_1_female_2015 <- x2_1_female_2015 %>% select(!c("sex","age","mem_stat","flag_x2"))
x2_female_2015 = rbind(x2_1_female_2015, x2_2_female_2015)
x2_female_2015 <- x2_female_2015[,c(1,3,4,5,6,7,8,9,10,11,12,13,2)]

#join individual reported consumption with recipe nutrition information, and calculate individual nutrient consumption per meal item
recipe_I = left_join(x2_female_2015,recipe_hh,by=c("a01","x2_meal"="time","x2_08"="menucode"))%>%
  dplyr::rename(meal_time=x2_meal,mid=x2_01,mealtaken=x2_03,sex_guest=x2_04,age_guest=x2_05,type_guest=x2_06,menucode=x2_08,icookwt=x2_09,ilocale=x2_11,iorder=x2_12,
                sample=hh_type.x)%>%
   mutate(i_mealkcal=(icookwt/menucookwt)*sum_kcal,i_mealprotein=(icookwt/menucookwt)*sum_protein,i_mealfat=(icookwt/menucookwt)*sum_fat,
          i_mealcarb=(icookwt/menucookwt)*sum_carb,i_mealcalcium=(icookwt/menucookwt)*sum_calcium,i_mealiron=(icookwt/menucookwt)*sum_iron)%>%
  dplyr::select(-hh_type.y,-contains("sum_"))



nutrition_2015_I = recipe_I%>%
  group_by(a01, mid) %>%
  filter(mealtaken==1)%>% #filter out if meal not taken
  dplyr::summarise(mealdata=n(),I_kcal=sum(i_mealkcal,na.rm=TRUE),I_protein=sum(i_mealprotein,na.rm=TRUE),I_fat=sum(i_mealfat,na.rm=TRUE),
                   I_carb=sum(i_mealcarb,na.rm=TRUE),I_calcium=sum(i_mealcalcium,na.rm=TRUE),I_iron=sum(i_mealiron,na.rm=TRUE))%>%
  filter(mid<100) #filter out guests

nrow(filter(nutrition_2015_I,I_kcal==0|is.na(I_kcal))) #89 without calorie info

rm(recipe_I,recipe_hh)
```


****** Nutrition data comparison (TBD)
```{r food data check}
#There are multiple data sets to corroborate:
# HH reports food purchase/produced/gifted within the last 7 days on o1_female
# HH reports food group consumption over last 7 days on x3_female
# HH reports consumption over prior 24 hours on x1_female


#sevenday_items_o1 = aggregate(a01~o1_01, data=o1_female_2015, FUN = length) #295 items

#sevenday_groups_x3 = 

#oneday_items_x1 = 
  


```


5. Calculate BMI
```{r BMI calculation, include=FALSE,results='hide'}
adult_2015=w1_female_2015%>%
mutate(BMI=w1_03/((w1_04/100)^2))%>%
  mutate(BMI=na_if(BMI,0),pregnant=if_else(is.na(w1_01)|w1_01==2,0,1),lactating=if_else(is.na(w1_02)|w1_02==2,0,1))%>%
 dplyr::rename(weight=w1_03,height=w1_04)%>%
  dplyr::select(-starts_with("w1_"))

child_2015=w2_female_2015%>%
mutate(BMI=w2_07/((w2_08/100)^2))%>%
 dplyr::rename(weight=w2_07,height=w2_08)%>%
  dplyr::select(a01,mid,weight,height,hh_type,BMI)%>%
  mutate(pregnant=0,lactating=0)

anthro_2015_I=bind_rows(adult_2015,child_2015)

# dupe=anthro_2015_I%>%
#   group_by(a01,mid,hh_type)%>%
#   filter(n()>1)


rm(adult_2015,child_2015)
```

6. Create Individual Roster
```{r roster_I,results='hide'}

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/")

###CREATE INDIVIDUAL ROSTER###
#add BMI and nutrition consumption to individual roster_2015\


#task(completed): delete "sex","age" columns in anthro_2015_I
anthro_2015_I <- anthro_2015_I %>% select(!c("sex","age"))

roster_2015_I=left_join(b1_male_2015,anthro_2015_I,by=c("a01","mid")) %>%
  dplyr::rename(hhid=a01,sex=b1_01,age=b1_02,relation=b1_03,marital=b1_04,abroad=b1_05,literacy=b1_07,
                    education=b1_08,occupation=b1_10,sampletype=hh_type) %>%
  left_join(nutrition_2015_I,by=c("hhid"="a01","mid"))
         
 
nrow(filter(roster_2015_I,is.na(mealdata))) #1158 are missing mealdata
roster_2015_I$mealdata[is.na(roster_2015_I$mealdata)] <- 0
roster_2015_I$pregnant[is.na(roster_2015_I$pregnant)] <- 0
roster_2015_I$lactating[is.na(roster_2015_I$lactating)] <- 0
nrow(filter(roster_2015_I,is.na(BMI))) #1724 are missing BMI

occupation_type = aggregate(mid~occupation, data=roster_2015_I, FUN = length) %>%
  dplyr::rename(n_I=mid)%>%
  left_join(occupationcodes,by=c("occupation"="occupation_code")) %>%
  mutate(activity=if_else(occupation %in% c(1:8,10,15,22,30,54,64:71),"heavy",
                          if_else(occupation %in% c(11,23:27,29,31:37,54:63),"moderate",
                                  "light")))%>%
  dplyr::select(1,3,2,4)

#write.xlsx(occupation_type,"./Clean Data/occupations/occupation_category.xlsx")
#detach("package:plyr", unload = TRUE)

# add back activity level, count number of household members, and flag polygamous HH
roster_2015_I = roster_2015_I %>%
  left_join(occupation_type,by="occupation")%>%
  dplyr::select(-n_I,-occupation_name)%>%
  #filter(!relation %in% c(16)) %>%
  group_by(hhid)%>%
  mutate(hhsize=n(),
         boy=if_else(age<18 & sex==1,1,0),
         girl=if_else(age<18 & sex==2,1,0),
         man=if_else(age>=18 & sex==1,1,0),
         woman=if_else(age>=18 & sex==2,1,0),
         adult=if_else(boy==0 & girl==0,1,0),
         child=if_else(man==0 & woman==0,1,0),
         otheradult=ifelse(relation>2 & adult==1,1,0),
         porl=if_else(pregnant==1 | lactating==1,1,0),
         spouseabroad=if_else(abroad==1 & relation==2,1,0))%>%
  ungroup()%>%
  group_by(hhid,relation)%>%
  mutate(poly=if_else(n()>1 & relation==2,1,0)) %>%
  ungroup()%>%
  dplyr::select(-contains("b1"))

nrow(filter(roster_2015_I,poly==1)) #30 individuals are duplicate partners (ie: 15 hh have two spouses)
          
rm(occupation_type,occupationcodes,anthro_2015_I,nutrition_2015_I)
```



7. Create Household, Household Head, and Spouse Rosters
```{r roster_HH, echo=FALSE}

###create household level roster_2015 and add AE by OECD definition
roster_2015_hh = roster_2015_I %>%
  group_by(hhid) %>%
  dplyr::summarise(hhsize = n(), adult=sum(adult),child=sum(child), poly=max(poly),
            boy=sum(boy),girl=sum(girl),otheradult=sum(otheradult),
            porl_hh=sum(porl,na.rm=TRUE), spouseabroad_hh=sum(spouseabroad,na.rm=TRUE),
            mealdata_hhmin=min(mealdata),hh_kcal=sum(I_kcal,na.rm=TRUE),hh_protein=sum(I_protein,na.rm=TRUE),hh_fat=sum(I_fat,na.rm=TRUE),
            hh_carb=sum(I_carb,na.rm=TRUE),hh_calcium=sum(I_calcium,na.rm=TRUE),hh_iron=sum(I_iron,na.rm=TRUE),
            sampletype=first(sampletype)) %>%
  mutate(porl_hh=if_else(is.na(porl_hh),0,porl_hh),AE_OECD=1+0.5*(adult-1)+0.3*child)

#6503 households

#filter individual roster_2015 to create head and spouse roster_2015s
roster_2015_head = filter(roster_2015_I,relation==1) %>%
   mutate(agehead=age, sexhead=sex, 
          maritalhead=marital,
          abroadhead=if_else(abroad==1,1,0),
          lithead=if_else(literacy==4,1,0),
          noschoolhead=if_else(education==99,1,0),
          secondschoolhead=if_else(education %in% c(10:12,22,33),1,0),
          agworkhead=if_else(occupation %in% c(1,64:71),1,0),
          BMIhead=BMI,I_kcalhead=I_kcal) %>%
  dplyr::select(hhid,contains("head"))
#6503 heads          
          
roster_2015_spouse = filter(roster_2015_I,relation==2) %>%
            mutate(agespouse=age,sexspouse=sex,
                   abroadspouse=if_else(abroad==1,1,0),
                   litspouse=if_else(literacy==4,1,0),
                   noschoolspouse=if_else(education==99,1,0),
                   secondschoolspouse=if_else(education %in% c(10:12,22,33),1,0),
                   agworkspouse=if_else(occupation %in% c(1,64:71),1,0),
                   BMIspouse=BMI,I_kcalspouse=I_kcal)%>%
  dplyr::select(hhid,ends_with("spouse"))
#5225 spouses

#add head and spouse characteristics back to household level roster_2015                   
roster_2015_hh=full_join(roster_2015_hh,roster_2015_head,by="hhid") 
roster_2015_hh=full_join(roster_2015_hh,roster_2015_spouse,by="hhid")
#6518 households = 6503+15 additional spouses in poly hh



dupe_hh = roster_2015_hh %>%
  #filter(sampletype==2 |sampletype==3)%>% 
  group_by(hhid) %>% 
  filter(n() > 1)#30 poly HH 

roster_2015_hh= distinct(roster_2015_hh,hhid, .keep_all= TRUE) #keeps only one line for each poly HH because HH level var are equivalent

rm(roster_2015_head,roster_2015_spouse,dupe_hh)

```

8. Calculate village level prices and HH expenditures
```{r expenditures, echo=FALSE,include=FALSE,results='hide'}

#task: change vcode_n to Village
villages = aggregate(a01~Village, data=a_male_2015, FUN = length) #318 villages
upazilla = aggregate(a01~uzcode, data=a_male_2015, FUN = length) #279 upazilla


#calculate household level weekly food expenditure
foodexp_2015 = left_join(o1_female_2015,a_male_2015,by="a01")%>%
  dplyr::select(a01,contains("o1"),Village,dcode)%>%
  mutate(o1_07a=if_else(o1_04 %in% c(1,2,3),o1_08/o1_06,o1_08/o1_05)) #category 1 is kg, cat 2 is g, 3 is liter, and now 4 is g
  #mutate(o1_06a=if_else(o1_04==2,o1_06/1000,o1_06), #change grams into kilos 
        # o1_07a=if_else(o1_04==4,(o1_08/o1_05)/1000,o1_07))%>% #alternate unit price=total val/number of kg reported

  
missing_exp=foodexp_2015%>%
  filter(is.na(o1_07a))

#calculate village level prices: unit mean and unit median prices if there are more than 3 observations in the village for the food item
# prices_village = o1_f_2015_hh%>%
#   dplyr::select(vcode_n,dcode,o1_01,o1_04,o1_06,o1_07,o1_08)%>%
#   arrange(dcode,vcode_n,o1_01,o1_04,o1_07)%>%
#   group_by(o1_01,vcode_n) %>%
#   filter(!is.na(o1_07))%>%
#   dplyr::summarise(unitprice=ifelse(n()>3,mean(o1_07),0),medprice=ifelse(n()>3,median(o1_08/o1_06),0))%>%
#   dplyr::na_if(0) #convert zero to NA

prices=foodexp_2015%>%
  dplyr::select(o1_01,o1_04,o1_06,o1_07,o1_07a,o1_08)%>%
  #arrange(o1_01,o1_04)%>%
  group_by(o1_01,o1_04) %>%
dplyr::summarise(mp=median(o1_07a,na.rm=TRUE))

  # filter(!is.na(o1_07))%>%
  # dplyr::summarise(unitprice=ifelse(n()>3,mean(o1_07),0),medprice=ifelse(n()>3,median(o1_08/o1_06),0))%>%
  # dplyr::na_if(0) #convert zero to NA

#join food expenditures with village food prices
foodexp_2015 = left_join(foodexp_2015,prices,by=c("o1_01","o1_04"))%>%
  mutate(foodprod=mp*o1_10,foodother=mp*o1_11) %>%
 dplyr::na_if(0) #convert zero to NA
  
foodexp_2015_hh = foodexp_2015%>%
  group_by(a01) %>%
  dplyr::summarise(foodpurch_hhwk=sum(o1_08,na.rm=TRUE),foodprod_hhwk=sum(foodprod,na.rm=TRUE),
            foodother_hhwk=sum(foodother,na.rm=TRUE))%>%
  mutate(foodtot_hhwk=rowSums(.[2:3],na.rm=TRUE)) #only include purch and prod


#calculate household level weekly nonfood expenditure from monthly
nonfoodexp_2015_m = p1_male_2015 %>%
  group_by(a01) %>%
  dplyr::summarise(p1_02=sum(p1_02,na.rm=TRUE),p1_04=sum(p1_04,na.rm=TRUE)) %>%
  mutate(nonfoodexp1_hhwk=(p1_02+p1_04)*12/52) 

#calculate household level weekly nonfood expenditure from annual
nonfoodexp_2015_y = p2_male_2015 %>%
  group_by(a01) %>%
  dplyr::summarise(p2_03=sum(p2_03,na.rm=TRUE),p2_06=sum(p2_06,na.rm=TRUE)) %>%
  mutate(nonfoodexp2_hhwk=(p2_03+p2_06)/52)    

#combine all nonfood exp expenditures
nonfoodexp_2015_hh=left_join(nonfoodexp_2015_m,nonfoodexp_2015_y,by="a01") %>%
  mutate(nonfoodexp_hhwk=nonfoodexp1_hhwk + nonfoodexp2_hhwk) %>%
  dplyr::select(a01,nonfoodexp_hhwk)



#add food expenditures to household roster_2015
roster_2015_hh=left_join(roster_2015_hh,nonfoodexp_2015_hh,by=c("hhid"="a01")) %>%
  mutate(nonfoodexp_hhwk_pc=nonfoodexp_hhwk/hhsize,
         nonfoodexp_hhwk_AE_OECD=nonfoodexp_hhwk/AE_OECD)%>%
left_join(foodexp_2015_hh,by=c("hhid"="a01")) %>%
  mutate(foodpurch_hhwk_pc = foodpurch_hhwk/hhsize,
    foodpurch_hhwk_AE_OECD = foodpurch_hhwk/AE_OECD,
    foodtot_hhwk_pc = foodtot_hhwk/hhsize,
    foodtot_hhwk_AE_OECD = foodtot_hhwk/AE_OECD)%>%
  mutate(foodshare=if_else(nonfoodexp_hhwk>0 & foodtot_hhwk>0,foodtot_hhwk/(foodtot_hhwk+nonfoodexp_hhwk),0),
         totexp_hhwk=nonfoodexp_hhwk+foodtot_hhwk)

#dplyr::na_if(roster_2015_hh$foodshare,0) #convert zero to NA

rm(nonfoodexp_m_hh,nonfoodexp_y_hh,upazilla,villages,prices,foodexp_2015,foodexp_2015_hh,nonfoodexp_2015_hh,nonfoodexp_2015_m,nonfoodexp_2015_y,missing_exp)

```

9. Food Security measures (hdds tbd)
```{r food security, echo=FALSE}

foodsecurity=x3_female_2015%>%
  dplyr::rename(hhid=a01,nofood_freq=x3_02,hungrynight_freq=x3_04,hungryday_freq=x3_06)%>%
  mutate(nofood=if_else(x3_01==1,1,0),hungrynight=if_else(x3_03==1,1,0),hungryday=if_else(x3_05==1,1,0))%>%
  mutate(cereal_days=x3_07_1+x3_07_2+x3_07_4,
         tuber_days=x3_07_3,
         vegetable_days=x3_07_5,
         fruit_days=x3_07_6 ,
         meat_days=x3_07_10+x3_07_11,
         egg_days=x3_07_8,
         seafood_days=x3_07_12 ,
         pulse_days=x3_07_7+x3_07_16,
         milk_days=x3_07_9,
         fat_days=x3_07_13 ,
         sugar_days=x3_07_14 ,
         misc_days=x3_07_15+x3_07_17)%>%
  mutate_at(.vars=vars(contains("days")),.funs=list(~as.numeric(.)))%>%
    mutate_at(.vars=vars(contains("days")),.funs=list(~if_else(.>7,7,.)))%>%
mutate_at(.vars=vars(contains("days")),.funs=funs(`1`=if_else(.>0,1,0)))%>%
rename_at(.vars=vars(contains("days")),.funs=funs(sub("_days_1","",.)))%>%
   dplyr::select(-contains("x"))%>%
mutate(hhds=rowSums(.[21:32],na.rm=TRUE))%>%
  dplyr::select(hhid,hhds,contains("food"),contains("hungry"),-contains("freq"),-contains("seafood"))


# fx=function(x){
#   mutate(temp=if_else(x>0,1,0))
#   dplyr::rename(gsub("_days","",x)==temp)
# }
          
          

  
#add back to HH level roster
roster_2015_hh=left_join(roster_2015_hh,foodsecurity,by="hhid")


rm(foodsecurity)

```



(tbd) Assistance Type
```{r assistance, echo=FALSE}
#breakdown of assistance type (for all households)
# assistance = u_male_2015 %>%
#   filter(u01==1) 
# 
# assistance_count = aggregate(a01~slno, data=assistance, FUN = length)

# %>%
#   group_by(a01)%>%
#   summarise(u01_hh=n(mid_1)+n(mid_2))
```

Clean up global environment
```{r}

rm(list=ls(pattern="male")) 
   
```



Descriptives
D1. Summary of unweighted sample (6503 HH)
```{r total sample, echo=FALSE}

### SUMMARY of all 6503 households (ie: 15 hh dropped with two spouses)
summary.hh.2015= roster_2015_hh %>%
    psych::describe() %>%
  as_tibble(rownames="rowname") %>%
  dplyr::select(rowname,n,mean,sd)

#print(roster_2015_hh.summary,digits=3)


```


D2. Add survey weights and restrict to representative sample (5503 HH)
```{r summary, echo=FALSE}


hh_type = aggregate(hhid~sampletype, data=roster_2015_hh, FUN = length)
#1:FTF Original 1000
#2:FTF Additional 1080
#3:National Representative 4423

#import weights
weights_2015 <- read_dta("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Raw Data/bihs_2015/IFPRI_BIHS_R2_exp.dta") %>%
  dplyr::select(a01,dvcode,vcode,aeu,hhweightR2,popweightR2)

#weights_2015 <- read_dta("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Raw Data/bihs_2015/IFPRI_BIHS_R2_exp.dta")


#choose sample type 2 and 3, eliminate poly households
w.hh.roster.2015=left_join(roster_2015_hh,weights_2015,by=c("hhid"="a01"))%>%
  filter(sampletype==2 |sampletype==3)
#%>%filter(poly==0&spouseabroad_hh==0)

#choose sample type 2 and 3, eliminate poly households & children under 1 & individuals w/out mealdata
w.I.roster.2015=left_join(roster_2015_I,weights_2015,by=c("hhid"="a01"))%>%
  filter(sampletype==2 |sampletype==3)%>%
  filter(I_kcal>0 & mealdata>0 &age>=2)%>%
   dplyr::select(-poly,-mealdata)
#&poly==0&abroad==2&spouseabroad==0)

 


design_HH <- svydesign(data=w.hh.roster.2015,id=~vcode, strata=~dvcode,weights=~hhweightR2)
design_I <- svydesign(data=w.I.roster.2015,id=~vcode, strata=~dvcode,weights=~popweightR2)


# summary.w.hh.2015= w.hh.roster.2015 %>%
#   dplyr::select(hhsize,adult,child,totexp_hhwk,foodshare,hhds,contains("head"),contains("spouse"),vcode,dvcode,popweight1)%>%
#     psych::describe() %>%
#   as_tibble(rownames="rowname") %>%
#   dplyr::select(rowname,n,mean,sd)


listx = dplyr::select(w.hh.roster.2015,hhsize,adult,child,totexp_hhwk,foodshare,hhds,contains("head"),contains("spouse"),-contains("abroad"))%>%
  mutate_at(.vars=vars(contains("sex")),.funs=list(~recode(.,"2=0")))%>%
  mutate(maritalhead=if_else(maritalhead==2,1,0))
  #-contains("sex"),-contains("marital"))

a=svymean(listx,design_HH,na.rm=TRUE)
#ab=print(ftable(a),rownames=c("Household Size","Number of Adults","Number of Children"),digits=2)
ab=as.data.table(a,keep.rownames=T)

ab$rownames<-c("Size","Number of Adults","Number of Children","Total Weekly Expenditure (2012 Taka)","Food Share of Total Expenditure","Household Dietary Diversity Score","Age (Years)","Male ","Married ","Literacy ","No Schooling ","Secondary Schooling ","Agricultural Worker ","Body Mass Index (BMI)","Reported Calorie Consumption (kcal)","Age (Years)","Male ","Literacy ","No Schooling ","Secondary Schooling ","Agricultural Worker ","Body Mass Index (BMI)","Reported Calorie Consumption (kcal)")

abc=ab%>%
  dplyr::select(rownames,mean,SE)%>%
   mutate(mean=if_else(mean<1,paste0(round(mean*100,2),"%"),as.character(round(mean,2))))
  

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Programs/R/output")

descriptives=kable(abc,booktabs=TRUE,digits=3,
                   col.names=c("Variable","Weighted Mean","SD"),escape=F)%>%
  kable_styling(full_width=FALSE,bootstrap_options = "condensed")%>%
  pack_rows("Household",1,6)%>%
pack_rows("Household Head",7,15)%>%
 pack_rows("Spouse of Household Head",16,23)%>% 
 footnote(general="Data are population-weighted means and standard deviations using sample weights provided by IFPRI")


print(descriptives)

save_kable(descriptives,"BIHS_Projectdescriptives.png")


#a=qflextable(ab)
#write.table(ab,file="/Users/juli/Desktop/BIHS/master/BIHS_Project/Programs/R/output/descriptives.doc")


rm(listx,ab,a,abc)

```


Import India Reference standards and Energy Requirements
```{r India}

#INDIA requirements and AE
#read in adult equivalent from India
AE_India <-read_excel("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards/GuidelinesIndia_2011.xlsx",sheet="AE_India",range = "A1:D13",col_types =  "numeric")


#join AE 
w.I.roster.2015=fuzzy_left_join(w.I.roster.2015,AE_India, 
                by=c("age"="agemin", "age"="agemax"),
                match_fun=list(`>=`, `<=`))%>%
  mutate(AE_India_grp=if_else(sex==1,AE_male,if_else(sex==2 & porl==1,1.17,AE_female)))%>%
  dplyr::select(-(39:42))


#India Dietary requirements
India_RDA<-read_excel("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards/GuidelinesIndia_2011.xlsx",sheet="India_RDA",range = "A1:k19",col_names = TRUE)%>%
  mutate(sex=if_else(sex=="male",1,2),agemin=as.numeric(agemin),agemax=as.numeric(agemax),
         activity=if_else(is.na(activity),"moderate",activity))%>%
  dplyr::select(-1)


#join India requirements (all are using ref weight and height, and assume moderate activity for under 18 p66 Inida (2009))
#task: unselect agemin and agemax in w.I roster.2015
w.I.roster.2015=w.I.roster.2015%>%
  select(!c("agemin","agemax"))%>%
  mutate(activityI=if_else(age>=18,activity,"moderate"))%>%
  fuzzy_left_join(India_RDA,
                by=c("sex","activityI"="activity","age"="agemin", "age"="agemax"),
                match_fun=list(`==`,`==`,`>=`, `<=`))%>%
   dplyr::rename(activity=activity.x,sex=sex.x,weight_India_grp=refwt_India)%>%
  mutate(age_grp_India=if_else(!is.na(agemin),paste(as.character(agemin),as.character(agemax),sep="-"),as.character(NA)),
    kcal_India_grp=if_else(pregnant==1,kcal_India+350,if_else(lactating==1,kcal_India+560,kcal_India))
       ,protein_rda_India=if_else(pregnant==1,protein_rda_India+23,if_else(lactating==1,protein_rda_India+16,protein_rda_India)),
    #calcium_rda_India=if_else(porl==1,1200,calcium_rda_India),
    #iron_rda_India=if_else(porl==1,21,iron_rda_India)
    )%>%
  dplyr::select(-contains(".y"),-agemin,-agemax,-calcium_rda_India,-iron_rda_India,-kcal_India)

#task : the columns of w.I roster.2015 are different from those of  w.I roster.2011
rm(list=ls(pattern="India"))


```


Import FAO height weight and BMI reference standards and energy Requirements
```{r FAO}

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards")

#FAO weight height
hfa_girls_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_girls_25",col_names = TRUE)%>%
  mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("h_P"))%>%
  filter(year%in%(2:4))%>%
  mutate(h_med=h_P50)

wfa_girls_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_girls_05",col_names = TRUE)%>%
  mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("w_P"))%>%
  filter(year%in%(2:4))%>%
  mutate(w_med=w_P50)

girls_24=left_join(hfa_girls_24,wfa_girls_24,by=c("sex","year","month"))

hfa_girls_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_girls_519",col_names = TRUE)%>%
   mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("h_P"))%>%
  mutate(h_med=h_P50)

wfa_girls_510 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_girls_510",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("w_P"))%>%
  mutate(w_med=w_P50)

bmi_girls_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="bmi_girls_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("b",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("b_P"))%>%
  mutate(b_med=b_P50)

girls_519=left_join(hfa_girls_519,wfa_girls_510,by=c("sex","year","month"))%>%
  left_join(bmi_girls_519,by=c("sex","year","month"))%>%
  mutate(w_med=if_else(is.na(w_med),b_med*(h_med/100)^2,w_med))

girls=bind_rows(girls_24,girls_519)

girls_19=girls%>%
  filter(year==19)%>%
  dplyr::select(contains("med"))

women_20=tibble(year=seq(20,120,1),sex=2,h_med=girls_19$h_med,w_med=girls_19$w_med)

FAO_women=bind_rows(girls,women_20)%>%
  mutate(w_med=if_else(is.na(w_med)&year<19,b_med*(h_med/100)^2,w_med))%>%
  group_by(sex,year)%>%
   dplyr::summarise(across(everything(),median,na.rm=TRUE))%>%
  dplyr::select(-month)%>%
  mutate(pregnant=0,lactating=0)

FAO_women_med=FAO_women%>%
  dplyr::select(sex,year,contains("_med"),pregnant,lactating)


for(i in 14:50){
  x=FAO_women_med%>%
    filter(year==i)%>%
    mutate(pregnant=1,b_med=as.numeric(NA),w_med=w_med+13.25)
  
  y=FAO_women_med%>%
    filter(year==i)%>%
    mutate(lactating=1)
  
  FAO_women_med=rbind(FAO_women_med,x,y)
}
    
rm(list=ls(pattern="girls"),women_20,x,y)
 

hfa_boys_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_boys_25",col_names = TRUE)%>%
  mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("h_P"))%>%
  filter(year%in%(2:4))%>%
  mutate(h_med=h_P50)

wfa_boys_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_boys_05",col_names = TRUE)%>%
  mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("w_P"))%>%
  filter(year%in%(2:4))%>%
  mutate(w_med=w_P50)

boys_24=left_join(hfa_boys_24,wfa_boys_24,by=c("sex","year","month"))


hfa_boys_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_boys_519",col_names = TRUE)%>%
   mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("h_P"))%>%
  mutate(h_med=h_P50)

wfa_boys_510 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_boys_510",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("w_P"))%>%
  mutate(w_med=w_P50)

bmi_boys_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="bmi_boys_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
    dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("b",.,sep="_")))%>%
  dplyr::select(sex,year,month,contains("b_P"))%>%
  mutate(b_med=b_P50)

boys_519=left_join(hfa_boys_519,wfa_boys_510,by=c("sex","year","month"))%>%
  left_join(bmi_boys_519,by=c("sex","year","month"))%>%
  mutate(w_med=if_else(is.na(w_med),b_med*(h_med/100)^2,w_med))

boys=bind_rows(boys_24,boys_519)

boys_19=boys%>%
  filter(year==19)%>%
  dplyr::select(contains("med"))

men_20=tibble(year=seq(20,120,1),sex=1,h_med=boys_19$h_med,w_med=boys_19$w_med) 

FAO_men=bind_rows(boys,men_20)%>%
  mutate(w_med=if_else(is.na(w_med)&year<19,b_med*(h_med/100)^2,w_med))%>%
  group_by(sex,year)%>%
   dplyr::summarise(across(everything(),median,na.rm=TRUE))%>%
  dplyr::select(-month)%>%
  mutate(pregnant=0,lactating=0)

FAO_men_med=FAO_men%>%
  dplyr::select(sex,year,contains("_med"),pregnant,lactating)

rm(list=ls(pattern="boys"),men_20)

FAO_hwb=bind_rows(FAO_women,FAO_men)

FAO_hwb_med=bind_rows(FAO_women_med,FAO_men_med)%>%
  mutate(age_grp_FAO=if_else(year%in%(4:8),"4-8",if_else(year%in%(9:13),"9-13",if_else(year%in%(14:18),"14-18",if_else(year%in%(19:30),"19-30",if_else(year%in%(31:50),"31-50",if_else(year%in%(51:69),"51-69",if_else(year>=70,"70 and over",as.character(year)))))))))%>%
  rename(age=year)%>%
  group_by(sex,age_grp_FAO)%>%
  mutate(h_FAO_grp=median(h_med),w_FAO_grp=median(w_med))%>%
  rename(h_FAO=h_med,w_FAO=w_med,b_FAO=b_med)

rm(list=ls(pattern="men"))


#read in energy requirement formulas
FAO_adult <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="Adult_BMRPAL",range = "A1:M37",col_names = TRUE)%>%
  dplyr::select(1:6,9:11,13)%>%
  mutate(sex=if_else(sex=="Male",1,2))%>%
  filter(agemin>=18)

FAO_child <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="Child_TEEPAL",range = "A1:P97",col_names = TRUE)%>% 
  mutate(sex=if_else(sex=="Male",1,2))%>%
dplyr::select(1:6,11,13,14,16)

FAO=bind_rows(FAO_adult,FAO_child)


FAO_energy=FAO_hwb_med%>%
    fuzzy_left_join(FAO,by=c("sex"="sex","age"="agemin","age"="agemax"),match_fun=list(`==`,`>=`,`<`))%>%
  rename(sex=sex.x)%>%
  dplyr::select(-sex.y,-agemin,-agemax)%>%
 mutate(protein_FAO_age=if_else(pregnant==1,protein_FAO_perkg*w_FAO+14,
                                if_else(lactating==1,protein_FAO_perkg*w_FAO+15.75,
                                        protein_FAO_perkg*w_FAO)),
   kcal_FAO_age=if_else(pregnant==1,multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp)+285,
                           if_else(lactating==1,multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp)+485,
                           multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp))),
    kcal_FAO_grp=if_else(pregnant==1,multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp)+285,
                           if_else(lactating==1,multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp)+485,
                           multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp))))%>%
  dplyr::rename(weight_FAO_age=w_FAO,height_FAO_age=h_FAO,weight_FAO_grp=w_FAO_grp,height_FAO_grp=h_FAO_grp,BMI_FAO_age=b_FAO)
    
    

base_FAO=FAO_energy%>%
  filter(age==18,sex==1,activity=="moderate")

base_kcal_FAO=base_FAO$kcal_FAO_age


#join FAO standards with roster
#calculate energy and protein requirements using reference and individual weights, activity adjustments for everyone
w.I.roster.2015=w.I.roster.2015%>%
 mutate(sex=as.numeric(sex))%>%
  left_join(FAO_energy,by=c("sex","age","activity","pregnant","lactating"))%>%
mutate(kcal_FAO_I=if_else(pregnant==1,multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp)+285,
                           if_else(lactating==1,multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp)+485,
                           multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp))),
       AE_FAO_I=kcal_FAO_I/base_kcal_FAO,AE_FAO_age=kcal_FAO_age/base_kcal_FAO,AE_FAO_grp=kcal_FAO_grp/base_kcal_FAO,
       BMI_FAO_age=if_else(age>18,21.5,BMI_FAO_age))%>%
  dplyr::select(-(kc:multiplier))
  

rm(list=ls(pattern="FAO"))



```


Import IOM height weight and Nutrient Requirements
```{r IOM}

library(plyr)

#DRI standards
#energy requirements
IOM_energy <- read_excel("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards/IOM_requirements.xlsx",sheet="Energy_IOM",range = "A1:R97",col_names = TRUE)%>% 
  mutate(sex=if_else(sex=="Male",1,2),activity=revalue(PA_level,c("sedentary"="light","low active"="light","active"="moderate","very active"="heavy")),pregnant=if_else(lifestage=="Pregnancy",1,0),lactating=if_else(lifestage=="Lactation",1,0))%>%
dplyr::select(-1,-2,-PA_level,-age_refmean,-EER_eq)%>%
dplyr::rename(agemin=age_lower_yrs,agemax=age_upper_yrs,kcal_IOM_grp=EER_IOM_ref,height_IOM_grp=refht_IOM,weight_IOM_grp=refwt_IOM)%>%
  group_by(sex,agemin,agemax,activity,pregnant,lactating)%>%
  dplyr::summarise_all(mean)%>%
  ungroup()%>%
  mutate(agemax=as.numeric(agemax))%>%
  mutate(agemax=if_else(is.na(agemax),150,agemax))

#nutrient requirements
IOM_nutrients <- read_excel("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards/IOM_requirements.xlsx",sheet="Nutrients",range = "A1:T23",col_names = TRUE)%>% 
#dplyr::select(-9,-11)%>% 
  mutate(sex=if_else(sex=="Male",1,2),pregnant=if_else(lifestage=="Pregnancy",1,0),lactating=if_else(lifestage=="Lactation",1,0))%>%
  dplyr::rename(agemin=age_lower_yrs,agemax=age_upper_yrs,calcium_rda_IOM=calcium_rda,calcium_ear_IOM=calcium_ear,
                iron_rda_IOM=iron_rda,iron_ear_IOM=iron_ear,
                carb_IOM_ear=carb_ear,carb_IOM_rda=carb_rda,carb_IOM_lower=carbohydrate_lower,carb_IOM_upper=carbohydrate_upper,
                protein_IOM_lower=protein_lower,protein_IOM_upper=protein_upper,protein_rda_IOM=protein_rda,
                fat_IOM_lower=lipids_lower,fat_IOM_upper=lipids_upper)%>%
  dplyr::select(-lifestage,-refht_IOM,-refwt_IOM)


base_IOM=IOM_energy%>%
  filter(agemin==19,sex==1,activity=="moderate")

base_kcal_IOM=base_IOM$kcal_IOM_grp


#join DRI energy standards with roster (calculate individual and reference requirements, everyone has activity adjustments)
w.I.roster.2015=w.I.roster.2015%>%
 fuzzy_left_join(IOM_energy,by=c("sex","age"="agemin", "age"="agemax","activity","pregnant","lactating"),match_fun=list(`==`,`>=`, `<=`,`==`,`==`,`==`))%>%
dplyr::rename(sex=sex.x,activity=activity.x,pregnant=pregnant.x,lactating=lactating.x)%>%
mutate(age_grp_IOM=if_else(!is.na(agemin),paste(as.character(agemin),as.character(agemax),sep="-"),as.character(NA)))%>%
  mutate(kcal_IOM_I=eer1-(eer2*age)+refPA*((eer3*weight)+(eer4*height/100))+eer5+eer6)%>%
  mutate(AE_IOM_grp=kcal_IOM_grp/base_kcal_IOM,AE_IOM_I=kcal_IOM_I/base_kcal_IOM)%>%
  dplyr::select(-contains(".y"),-agemin,-agemax,-refPA,-contains("eer"))
  


#generate individual and reference nutrient standards for IOM
w.I.roster.2015=w.I.roster.2015%>%
   fuzzy_left_join(IOM_nutrients,by=c("sex","age"="agemin","age"="agemax","pregnant","lactating"), match_fun=list(`==`,`>=`, `<=`,`==`,`==`))%>%
  dplyr::rename(sex=sex.x,pregnant=pregnant.x,lactating=lactating.x)%>%
    mutate(protein_ear_IOM_grp=protein_ear_perkg*weight_IOM_grp,protein_ear_IOM_I=protein_ear_perkg*weight)%>%
    dplyr::select(-contains(".y"),-protein_ear_perkg,-agemin,-agemax)

xlist=c("protein","carb")
ylist=c("lower","upper")
#zlist=c("grp","I")

for (x in xlist){
  for (y in ylist){
   # for (z in zlist){
 w.I.roster.2015[[paste(x,y,"IOM_grp",sep="_")]]<-  (w.I.roster.2015[[paste(x,"IOM",y,sep="_")]]/100)*w.I.roster.2015[[paste("kcal_IOM_grp",sep="_")]]/4

#}
}
}

xlist=c("fat")
ylist=c("lower","upper")
#zlist=c("grp","I")

for (x in xlist){
  for (y in ylist){
   # for (z in zlist){
 w.I.roster.2015[[paste(x,y,"IOM_grp",sep="_")]]<-  (w.I.roster.2015[[paste(x,"IOM",y,sep="_")]]/100)*w.I.roster.2015[[paste("kcal_IOM_grp",sep="_")]]/9

#}
}
}



w.I.roster.2015=w.I.roster.2015%>%
  dplyr::select(-contains("IOM_upper"),-contains("IOM_lower"))

rm(list=ls(pattern="IOM"),x,y,z,xlist,ylist,zlist)


```


Reference weights and Heights and add back HH variables
```{r refwtht}

#reference weights and heights
ref_wtht = w.I.roster.2015%>%
  dplyr::select(hhid,mid,sex,sampletype,age,contains("age_grp"),pregnant,lactating,contains("weight"),contains("height"),contains("code"),contains("R2"))

#add back HH-level variables and generate hh level variables
hh=w.I.roster.2015%>%
  dplyr::select(hhid,contains("AE"),-aeu)%>%
  group_by(hhid)%>%
  dplyr::summarise_all(sum,na.rm=TRUE)%>%
  dplyr::rename_at(.vars=vars(4:9),.funs=funs(sub("AE_","hhsize_",.)))
#task: vars(2:7) into vars(4:9)
w.hh.roster.2015=left_join(w.hh.roster.2015,hh,by="hhid")

h=w.hh.roster.2015%>%
  dplyr::select(hhid,contains("hhsize_"),contains("hh_"),AE_OECD,hhds,nofood,hungryday,hungrynight)%>%
  dplyr::rename(hhsize_OECD=AE_OECD)
#task: w.I.roster.2015 does not have column named "hhsize_IOM_grp"
w.I.roster.2015=left_join(w.I.roster.2015,h,by="hhid")%>%
  mutate(share_India_grp=AE_India_grp/hhsize_India_grp,share_FAO_grp=AE_FAO_grp/hhsize_FAO_grp,share_IOM_grp=AE_IOM_grp/hhsize_IOM_grp,share_FAO_I=AE_FAO_I/hhsize_FAO_I,share_IOM_I=AE_IOM_I/hhsize_IOM_I,share_FAO_age=AE_FAO_age/hhsize_FAO_age,
         age_range=if_else(age>=2&age<4,"Toddler (2-3)", 
                           if_else(age>=4&age<8,"Young Child (4-7)",
                             if_else(age>=8&age<11,"Older Child (8-10)",
                              if_else(age>=11&age<14,"Young Adolescent (11-13)",
                              if_else(age>=14&age<18,"Older Adolescent (14-17)",
                                if_else(age>=18&age<30,"Young Adult (18-29)",
                                if_else(age>=30&age<=60,"Adult (30-59)",
                                if_else(age>60,"Older Adult (60+)",as.character(NA))))))))))


rm(h,hh,i)

```


Summary Table for D&T
```{r DT, echo=FALSE}

# ## SUMMARY TABLES FOR D&T SUBSET
# # "we restrict the sample to households with male, married heads whose spouses are present and to
# # households without pregnant or lactating women. This sample of 3,060 house-holds..." (page 631)
# 
# ##DST TABLE 1
# roster_hh_DST = wroster_2015_hh %>%
#   filter(sexhead==1 & maritalhead==2 & abroadhead==0 & poly==0 & porl_hh==0 & spouseabroad_hh==0) 
# 
# #nrow(filter(roster_hh_DST,is.na(BMIhead))) #86 missing
# #nrow(filter(roster_hh_DST,is.na(BMIspouse))) #45 missing
# 
# design_hh_DT <- svydesign(data=roster_hh_DST,id=~vcode, strata=~dvcode,weights=~hhweightR1)
# 
# listx = dplyr::select(roster_hh_DST,22,53,63,66,2,19,20,6,7,8,33,37:42,43,46:51)
# a=svymean(listx,design_hh_DT,na.rm=TRUE)
# print(ftable(a),digits=2)
# 
# #this is not weighted, use svymean for weighted results
# roster_hh_DST.summary = roster_hh_DST %>%
#   psych::describe() %>%
#   as_tibble(rownames="rowname") %>%
#   dplyr::select(rowname,n,mean,sd)
# 
# #print(roster_hh_DST.summary,digits=3)
# # 
# # table1= dplyr::bind_cols(roster_2015_hh.summary,roster_hh_DST.summary) %>%
# #   dplyr::select(-rowname1)%>%
# #   dplyr::rename(obs_full=n,mean_full=mean,sd_full=sd,obs_sample=n1,mean_sample=mean1,sd_sample=sd1) %>%
# #   dplyr::filter(rowname=="hhdaycalperAE" |rowname=="hhdayecalperAE" | rowname=="nonfoodexp_hhwkpc" | rowname=="foodpurch_hhwkpc" | rowname=="foodshare" | rowname=="hhsize" | rowname=="AE" | rowname=="boy" | rowname=="girl" | rowname=="otheradult"
# #                 | rowname=="agehead" |rowname=="lithead" |rowname=="noschoolhead" |rowname=="secondschoolhead" |rowname=="agworkhead" |rowname=="BMIhead"
# #                 | rowname=="agespouse" |rowname=="litspouse" |rowname=="noschoolspouse" |rowname=="secondschoolspouse" |rowname=="agworkspouse" |rowname=="BMIspouse") 
# # 
# # 
# # kable(table1,booktabs=TRUE,digits=2,caption="Table 1", col.names=c("Variable","N","Mean","SD","N","Mean","SD"),align='r')%>%
# #   kable_styling(full_width=TRUE)%>%
# #   pack_rows("Household Head",8,13)%>%
# #   pack_rows("Spouse",14,19)%>%
# #   pack_rows("Expenditures",20,22)%>%
# #   add_header_above(c(" "=1,"All Households"=3,"D&T Sample"=3))
# # 
# 
# ###TABLE 3
# roster_I_DST=wroster_2015_I%>%
#   filter(sexhead==1 & maritalhead==2 & abroadhead==0 & poly==0 & porl_hh==0 & spouseabroad_hh==0)%>%
#   mutate(BMIunder=if_else(BMI<18.5,(18.5-BMI)/18.5,0),
#          adultgrp=if_else(relation==1,"head",if_else(relation==2,"spouse",if_else(otheradult==1,"otheradult",as.character(NA)))))%>%
#    filter(!is.na(agegrp_DST),!is.na(BMI),!is.na(adultgrp))%>%
#   dplyr::select(hhid,mid,agegrp_DST,adultgrp,BMI,BMIunder,vcode,dvcode,popweightR1)
# 
# #%>%
#  # reshape2::cast(agegrp~adultgrp,fun.aggregate=c(mean,sd,n))
# 
# #roster_I_DST$DST[is.na(roster_I_DST$DST)]<-0 #convert zero to NA
# design_I_DT <- svydesign(data=roster_I_DST,id=~vcode, strata=~dvcode,weights=~popweightR1)
# 
# table3= roster_I_DST %>%
#   group_by(agegrp_DST,adultgrp) %>%
#   summarise(mean=mean(BMIunder),se=sd(BMIunder)/sqrt(length(BMIunder)),n=n())%>%
#   reshape2::melt(id.vars=c("agegrp_DST","adultgrp"),measure.var=c("mean","se","n"))%>%
#   dplyr::arrange(agegrp_DST)%>%
#   unite(agegrp_DST,variable,col="agegrp_DST_var",sep="_")%>%
#   dcast(agegrp_DST_var~adultgrp,value.var = "value")%>%
#   separate(agegrp_DST_var,into=c("agegrp_DST","var"),"_")%>%
#   dplyr::select(var,head,spouse,otheradult)
# # 
# # 
# # kable(table3,booktabs=TRUE,digits=3,caption="Table 3: BMI Shortfalls", col.names=c("","Heads","Spouses","Other Adults"),align='r')%>%
# #   kable_styling(full_width=TRUE)%>%
# #   pack_rows("Ages 20-39",1,3)%>%
# #   pack_rows("Ages 40-59",4,6)%>%
# #   pack_rows("Ages 60 and up",7,9)
# 
# #%>%
#  # add_header_above(c(" "=1,"All Households"=3,"D&T Sample"=3))


```


METHODOLOGY

Individual reported variables:
1. Actual reported nutrient consumption (Six variables labeled "I_nutrient")
2. BMI (one variable labeled "BMI")

Individual calculated variables:
1. Allocated nutrient consumption = hh reported consumption/measure of HH size 
  a. Allocated by # of individuals (hhsize) (Six variables labeled "I_nutrient")
  b. Allocated by AE from DRI (hhsize_IOM) (Six variables labeled "I_nutrient")
  c. Allocated by AE from FAO (hhsize_FAO) (Six variables labeled "I_nutrient")
  d. Allocated by AE from India (hhsize_India) (Six variables labeled "I_nutrient")
  e. Allocated by AE from OECD (hhsize_OECD) (Six variables labeled "I_nutrient")
  
Individual Calculated measure = Total household consumption of nutrient/(individual AE/total hh AE)

Household level variables:
1. HDDS and 3 food security variables ("hhds,hungryday,hungrynight,nofood)



Summary Tables for Reference Weights and Heights and Adult Equivalents
```{r refwtht}

options(digits=3,knitr.kable.NA = '')

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Programs/R/output")
#task: cannot find the vcode in w.I.roster.2015
#compare reference weights by age group
allref=w.I.roster.2015%>%
  mutate(weight_India_grp_b=if_else(weight<weight_India_grp,1,0),
         weight_FAO_grp_b=if_else(weight<weight_FAO_grp,1,0),
          weight_FAO_age_b=if_else(weight<weight_FAO_age,1,0),
         weight_IOM_grp_b=if_else(weight<weight_IOM_grp,1,0),
         height_FAO_grp_b=if_else(height<height_FAO_grp,1,0),
          height_FAO_age_b=if_else(height<height_FAO_age,1,0),
         height_IOM_grp_b=if_else(height<height_IOM_grp,1,0),
         sex=as.factor(sex))%>%
  dplyr::select(hhid,mid,age,age_range,sex,contains("weight"),contains("height"),contains("AE_"),contains("code"),contains("R2"))
  
                

w_allref=allref%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,age_range)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(-contains("code"),-contains("R2"),-contains("hhid"),-contains("mid"),-contains("_se"))


w=allref%>%
  group_by(sex,age_range)%>%
    dplyr::summarise(n=n())

w_allref=left_join(w_allref,w,by=c("sex","age_range"))


age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
      "Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_allref$age_range<-reorder.factor(w_allref$age_range,new.order=age)
levels(w_allref$sex)<-list("Male"="1","Female"="2")

graph_allref=w_allref%>%
  arrange(age_range)%>%
mutate_at(vars(contains("_b")),funs(.*100))%>%
pivot_longer(cols=weight:AE_IOM_I,names_to=c("variable","source","reflevel","pct"),names_sep="_",values_drop_na = TRUE)%>%
  mutate(source=if_else(is.na(source),"sample",source),reflevel=if_else(is.na(reflevel),"sample",if_else(reflevel=="I","sample",reflevel)), sourceref=paste(source,reflevel,sep="_"))
         

x.label=c("Toddler \n (2-3)","Young Child \n (4-7)","Older Child \n (8-10)","Young Adolescent \n (11-13)","Older Adolescent \n (14-17)",
      "Young Adult \n (18-29)","Adult \n (30-59)","Older Adult \n (60+)")

sr=unique(graph_allref$sourceref)

wha=c("sample_sample","India_grp","FAO_age","FAO_grp","IOM_grp","FAO_sample","IOM_sample") 
lbl=c("Sample", "India (age group)","WHO (age)","WHO (age group)","IOM (age group)","WHO (sample wt/ht)","IOM (sample wt/ht)")

clr=c("black","green","blue","blue","red","blue","red")
lnt=c("dotted","solid","dashed","solid","solid","dashed","dashed")

w=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable=="weight"),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
  scale_y_continuous(name="Weight (kg)",limits=c(0,80),breaks=seq(0,80,10),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)))+theme(legend.position=c(0.6,0.75),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))

print(w)
ggsave("refweight_plot.png")

h=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable=="height"),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
  scale_y_continuous(name="Height (cm)",limits=c(0,200),breaks=seq(0,200,20),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)))+theme(legend.position=c(0.6,0.75),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(h)
ggsave("refheight_plot.png")

hw=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable%in%c("weight","height")),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
  #scale_y_continuous(name="Height (cm)",limits=c(0,200),breaks=seq(0,200,20),expand=c(0,0))+
  scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)),rows=vars(factor(variable)),scales="free_y")+theme(legend.position=c(0.6,0.75),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))


a=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable=="AE"),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
  scale_y_continuous(name="Adult Equivalents",limits=c(0,1.5),breaks=seq(0,1.5,0.1),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)))+theme(legend.position=c(0.5,0.75),legend.background=element_rect(size=0.75,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(a)
ggsave("AE_plot.png")




wtht_allref=w_allref%>%
    arrange(age_range)%>%
 mutate_at(vars(contains("_b")),funs(scales::percent(.,accuracy=.01)))
  dplyr::select(sex,age_range,age,weight,contains("weight_India_grp"),contains("weight_FAO_age"),contains("weight_FAO_grp"),contains("weight_IOM_grp"),height,contains("height_FAO_age"),contains("height_FAO_grp"),contains("height_IOM_grp"))

AE_allref=w_allref%>%
  arrange(age_range)%>%
  dplyr::select(sex,age_range,age,AE_FAO_I,AE_IOM_I,AE_FAO_age,AE_India_grp,AE_FAO_grp,AE_IOM_grp,n)


whref_print<-kable(wtht_allref,booktabs=TRUE,caption="Comparison of Reference Standards for Weight and Height",
      col.names=c("Sex","Age Range","Age","Sample","Reference Group","% Below","Reference Age","% Below","Reference Group","% Below","Reference Group","% Below","Sample","Reference Age","% Below","Reference Group","% Below","Reference Group","% Below"),
                  escape=F)%>%
  kable_styling(full_width=FALSE,"striped")%>%
  add_header_above(c(" "=3," "=1,"India"=2, "WHO/FAO"=4,"IOM"=2," "=1,"WHO/FAO"=4,"IOM"=2)) %>%
add_header_above(c(" "=3,"Weight (kg) "=9, "Height (cm) "=7)) %>%
   column_spec(c(1,3,12,19),border_right = TRUE)%>%
  #row_spec(c(3:4,7:8,11:12),background="gray90")%>%
 footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
          India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
          WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
          IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")

save_kable(whref_print,"refwtht.png")
print(whref_print)


AE_print<-kable(AE_allref,booktabs=TRUE,caption="Comparison of Adult Equivalents",
      col.names=c("Sex","Age Range","Age","WHO/FAO","IOM","WHO/FAO","India","WHO/FAO","IOM","N"),
                  escape=F)%>%
  kable_styling(full_width=FALSE,"striped")%>%
  add_header_above(c(" "=3,"Actual Weight/Height"=2,"Age Weight/Height"=1,"Reference Group Weight/Height"=3," "=1)) %>%
add_header_above(c(" "=3,"Adult Equivalents"=6," "=1)) %>%
   column_spec(c(1,3,9,10),border_right = TRUE)%>%
  #row_spec(c(3:4,7:8,11:12),background="gray90")%>%
 footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
          Adult Equivalent is equal to individual energy requirements relative to the energy requirements for an 18-30 year old male with moderate activity.
          India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
          WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
          IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")

save_kable(AE_print,"AE.png")
print(AE_print)



rm(allref,w,ref_wtht,a,h,w,graph_allref)


```



12. Individual inadequacy by comparing actual consumption to target (by nutrient)
```{r nutrient Inadequacy}

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Programs/R/output")

#######NUTRIENTS
#allocate share of total hh nutrient to each individual and separate into nutrient-specific tables
ref=c("India_grp","FAO_grp","IOM_grp","FAO_I","IOM_I","FAO_age")
for (i in 1:length(nutnames)) {
  
  temp=w.I.roster.2015%>%
    dplyr::select(1:4,BMI,age_range,contains("share"),contains(nutnames[[i]]),hhds,34:38,BMI_FAO_age)%>%
    arrange(hhid)
  
 for (j in ref){

temp[[paste0("I_share_",j,sep="_",nutnames[[i]])]]<-temp[[paste0("hh_",nutnames[[i]])]]*temp[[paste0("share_",j)]]


  }
   assign(paste(nutnames[[i]],"inadequacy",sep="_"),temp)
}


kcal_inadequacy=kcal_inadequacy%>%
  mutate( sex=as.factor(sex),BMI_inadequate_FAO_age=if_else(BMI<BMI_FAO_age,1,0),
         BMI_gap_FAO_age=if_else(BMI_inadequate_FAO_age==1,(BMI-BMI_FAO_age)/BMI_FAO_age,as.numeric(NA)))%>%
  group_by(hhid)%>%
  mutate_at(vars(starts_with("kcal_")), funs(hh_ = "sum"))%>%
      ungroup()%>%
mutate_at(.vars=vars(matches("hh_")),.funs=funs("inadequate"=if_else(hh_kcal<.,1,0)))%>%
  dplyr::select(-hh_kcal_inadequate)


#ENERGY (kcal/BMI)
for (j in ref){
  #actual reported consumption inadequacy
  kcal_inadequacy[[paste0("actual_inadequate_",j)]]<-if_else(kcal_inadequacy$I_kcal<kcal_inadequacy[[paste0("kcal",sep="_",j)]],1,0)
  kcal_inadequacy[[paste0("actual_gap_",j)]]<-if_else(kcal_inadequacy[[paste0("actual_inadequate_",j)]]==1,(kcal_inadequacy$I_kcal-kcal_inadequacy[[paste0("kcal",sep="_",j)]])/kcal_inadequacy[[paste0("kcal",sep="_",j)]],as.numeric(NA))
  
  kcal_inadequacy[[paste0("actual_Ina.HHok_",j)]]<-if_else(kcal_inadequacy[[paste0("actual_inadequate_",j)]]==1&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==0,1,0)
    kcal_inadequacy[[paste0("actual_Iok.HHin_",j)]]<-if_else(kcal_inadequacy[[paste0("actual_inadequate_",j)]]==0&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==1,1,0)
  
  #share allocation inadequacy
  kcal_inadequacy[[paste0("share_inadequate_",j)]]<-if_else(kcal_inadequacy[[paste0("I_share_",j,"_kcal")]]<kcal_inadequacy[[paste0("kcal",sep="_",j)]],1,0)
  kcal_inadequacy[[paste0("share_gap_",j)]]<-if_else(kcal_inadequacy[[paste0("share_inadequate_",j)]]==1,(kcal_inadequacy[[paste0("I_share_",j,"_kcal")]]-kcal_inadequacy[[paste0("kcal",sep="_",j)]])/kcal_inadequacy[[paste0("kcal",sep="_",j)]],as.numeric(NA))
 
   kcal_inadequacy[[paste0("share_Ina.HHok_",j)]]<-if_else(kcal_inadequacy[[paste0("share_inadequate_",j)]]==1&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==0,1,0) 
    kcal_inadequacy[[paste0("share_Iok.HHin_",j)]]<-if_else(kcal_inadequacy[[paste0("share_inadequate_",j)]]==0&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==1,1,0)
  
}

w_kcal=kcal_inadequacy%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,age_range)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(sex,age_range,contains("inadequate"),contains("gap"),contains("HHok"),contains("Iok"),-contains("_se"))

age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
      "Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_kcal$age_range<-reorder.factor(w_kcal$age_range,new.order=age)
w_kcal[w_kcal==0]<-as.numeric(NA)
levels(w_kcal$sex)<-list("Male"="1","Female"="2")

graph_kcal_f=w_kcal%>%
  arrange(age_range)%>%
    dplyr::select(1:2,BMI_inadequate_FAO_age,contains("actual_inadequate"),contains("share_inadequate"))%>%
    mutate_at(vars(contains("inadequate")),funs(.*100))%>%
pivot_longer(cols=3:15,names_to=c("variable","sourceref"),names_sep="_inadequate_",values_drop_na = TRUE)


x.label=c("Toddler \n (2-3)","Young Child \n (4-7)","Older Child \n (8-10)","Young Adolescent \n (11-13)","Older Adolescent \n (14-17)",
      "Young Adult \n (18-29)","Adult \n (30-59)","Older Adult \n (60+)")

sr=unique(graph_kcal_f$sourceref)

wha=c("India_grp","FAO_age","FAO_grp","IOM_grp","FAO_I","IOM_I") #5 for weight 
lbl=c("India (age group)","WHO/FAO (age)","WHO/FAO (age group)","IOM (age group)","WHO/FAO (sample wt/ht)","IOM (sample wt/ht)")

clr=c("green","blue","blue","red","blue","red")
lnt=c("dashed","dotted","dashed","dashed","solid","solid")



kcalf_m=ggplot()+geom_path(data=subset(graph_kcal_f,sex==1),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
  scale_y_continuous(name="Energy inadequacy % ",limits=c(0,100),breaks=seq(0,100,10),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(variable)))+theme(legend.position=c(0.5,0.4),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(kcalf_m)
ggsave("kf_plot_m.png")


kcalf_w=ggplot()+geom_path(data=subset(graph_kcal_f,sex==2),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
  scale_y_continuous(name="Energy inadequacy % ",limits=c(0,100),breaks=seq(0,100,10),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(variable)))+theme(legend.position=c(0.5,0.4),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(kcalf_w)
ggsave("kf_plot_w.png")


graph_kcal_inequality=w_kcal%>%
  arrange(age_range)%>%
    dplyr::select(1:2,contains("Iok"),contains("Hok"))%>%
pivot_longer(cols=3:26,names_to=c("v1","v2","v3","v4"),names_sep="_",values_drop_na = FALSE)%>%
  unite(v3,v4,col="sourceref",sep="_")%>%
  mutate(value=value*100)


k_inequality=ggplot()+geom_path(data=subset(graph_kcal_inequality,v1=="actual"),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+
  scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
  scale_y_continuous(name="Frequency (%) ",limits=c(0,50),breaks=seq(0,50,10),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)),rows=vars(factor(v2)))+theme(legend.position=c(0.5,0.4),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"),panel.spacing = unit(1, "lines"))

print(k_HHinequality)
ggsave("kf_HHineq.png")


fi_kcal=w_kcal%>%
  arrange(age_range)%>%
mutate_at(vars(contains("gap")),funs(scales::percent(.,accuracy=.1)))%>%
mutate_at(vars(contains("inadequate")),funs(scales::percent(.,accuracy=.1)))%>%
  dplyr::select(1:2,BMI_inadequate,contains("actual_inadequate"),contains("share_inadequate"),BMI_gap,contains("actual_gap"),contains("share_gap"))

fi_kcal[is.na(fi_kcal)]<-""

kcal_freq=fi_kcal%>%
  dplyr::select(sex,age_range,contains("inadequate"))

kcal_inten=fi_kcal%>%
  dplyr::select(sex,age_range,contains("gap"))





freq_kcal_print<-kable(kcal_freq,booktabs=TRUE,caption="Frequency of Energy Inadequacy by Reference Standard",
      col.names=c("Sex","Age Range","BMI",rep(list("India","FAO/WHO","IOM","FAO/WHO","IOM"),2)),
      escape=F)%>%
  kable_styling(full_width=FALSE,"striped","bordered")%>% 
    add_header_above(c(" "=2," " =1,rep(list("wrt Age Group Req"=3,"wrt Individual Req"=2),2)))%>% 
  add_header_above(c(" "=2," "=1,"Reported Individual Consumption"=5,"Allocated Household Consumption"=5))%>% 
#add_header_above(c(" "=2,"Frequency of Inadequacy"=11))%>% 
   column_spec(c(2,3,8,13),border_right = TRUE)%>%
  #row_spec(c(3:4,7:8,11:12),background="gray90")%>%
 footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
          Consumption share is equal to individual Adult Equivalents/Total Household Adult Equivalents.
          India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
          WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
          IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")


save_kable(freq_kcal_print,"kcal_freq.png")
print(freq_kcal_print)



inten_kcal_print<-kable(kcal_inten,booktabs=TRUE,caption="Intensity of Energy Inadequacy",
      col.names=c("Sex","Age Range","BMI",rep(list("India","FAO/WHO","IOM","FAO/WHO","IOM"),2)),
      escape=F)%>%
  kable_styling(full_width=FALSE,"striped","bordered")%>% 
    add_header_above(c(" "=2," " =1,rep(list("wrt Age Group Req"=3,"wrt Individual Req"=2),2)))%>% 
  add_header_above(c(" "=2," "=1,"Reported Individual Consumption"=5,"Allocated Household Consumption"=5))%>% 
#add_header_above(c(" "=2,"Frequency of Inadequacy"=11))%>% 
   column_spec(c(2,3,8,13),border_right = TRUE)%>%
  #row_spec(c(3:4,7:8,11:12),background="gray90")%>%
 footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
          Consumption share is equal to individual Adult Equivalents/Total Household Adult Equivalents.
          India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
          WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
          IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")


save_kable(inten_kcal_print,"kcal_inten.png")
print(inten_kcal_print)

rm(w_kcal,kcal_inadequacy)



#protein
for (j in ref){
  #actual reported consumption inadequacy
  protein_inadequacy[[paste0("actual_inadequate_",j)]]<-if_else(protein_inadequacy$I_protein<protein_inadequacy[[paste0("protein",sep="_",j)]],1,0)
  protein_inadequacy[[paste0("actual_gap_",j)]]<-if_else(protein_inadequacy[[paste0("actual_inadequate_",j)]]==1,(protein_inadequacy$I_protein-protein_inadequacy[[paste0("protein",sep="_",j)]])/protein_inadequacy[[paste0("protein",sep="_",j)]],as.numeric(NA))
  
  #share allocation inadequacy
  protein_inadequacy[[paste0("share_inadequate_",j)]]<-if_else(protein_inadequacy[[paste0("I_share_",j,"_protein")]]<protein_inadequacy[[paste0("protein",sep="_",j)]],1,0)
  protein_inadequacy[[paste0("share_gap_",j)]]<-if_else(protein_inadequacy[[paste0("share_inadequate_",j)]]==1,(protein_inadequacy[[paste0("I_share_",j,"_protein")]]-protein_inadequacy[[paste0("protein",sep="_",j)]])/protein_inadequacy[[paste0("protein",sep="_",j)]],as.numeric(NA))
  
}


w_protein=protein_inadequacy%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,age_range)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(sex,age_range,contains("inadequate"),contains("gap"),-contains("_se"))

age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
      "Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_protein$age_range<-reorder.factor(w_protein$age_range,new.order=age)
#w_protein[w_protein==0]<-as.numeric(NA)
#w_protein[is.na(w_protein)]<-""

w_protein=w_protein%>%
  arrange(age_range)%>%
mutate_at(vars(contains("gap")),funs(scales::percent(.,accuracy=.1)))%>%
mutate_at(vars(contains("inadequate")),funs(scales::percent(.,accuracy=.1)))%>%
  dplyr::select(1:2,contains("actual_inadequate"),contains("share_inadequate"),contains("actual_gap"),contains("share_gap"))



protein_print<-kable(w_protein,booktabs=TRUE,caption="Incidence of Protein Inadequacy",
      col.names=c("Sex","Age Range",rep(list("India","FAO/WHO","IOM","FAO/WHO","IOM"),4)),
      escape=F)%>%
  kable_styling(full_width=FALSE,"striped","bordered")%>% 
    add_header_above(c(" "=2,rep(list("wrt Age Group Req"=3,"wrt Individual Req"=2),4)))%>% 
  add_header_above(c(" "=2,rep(list("Reported Individual Consumption"=5,"Allocated Household Consumption"=5),2)))%>% 
add_header_above(c(" "=2,"Frequency of Inadequacy"=10, "Intensity of Inadequacy"=10))%>% 
   column_spec(c(2,7,12,17,22),border_right = TRUE)%>%
 footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
          Consumption share is equal to individual Adult Equivalents/Total Household Adult Equivalents.
          India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
          WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
          IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")


save_kable(protein_print,"protein.png")
print(protein_print)


#fat
fat_inadequacy=fat_inadequacy%>%
  dplyr::rename("fat_IOM"="fat_amdr_lower","fat_IOM2"="fat_amdr2")
fref=c("India","IOM","IOM2")

for (j in fref){
  #actual reported consumption inadequacy
  fat_inadequacy[[paste0("actual_inadequate_",j)]]<-if_else(fat_inadequacy$I_fat<fat_inadequacy[[paste0("fat",sep="_",j)]],1,0)
  fat_inadequacy[[paste0("actual_gap_",j)]]<-if_else(fat_inadequacy[[paste0("actual_inadequate_",j)]]==1,(fat_inadequacy$I_fat-fat_inadequacy[[paste0("fat",sep="_",j)]])/fat_inadequacy[[paste0("fat",sep="_",j)]],as.numeric(NA))
  
  #share allocation inadequacy
  fat_inadequacy[[paste0("share_inadequate_",j)]]<-if_else(fat_inadequacy[[paste0("I_share_",j,"_fat")]]<fat_inadequacy[[paste0("fat",sep="_",j)]],1,0)
  fat_inadequacy[[paste0("share_gap_",j)]]<-if_else(fat_inadequacy[[paste0("share_inadequate_",j)]]==1,(fat_inadequacy[[paste0("I_share_",j,"_fat")]]-fat_inadequacy[[paste0("fat",sep="_",j)]])/fat_inadequacy[[paste0("fat",sep="_",j)]],as.numeric(NA))
  
}


w_fat=fat_inadequacy%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,age_range)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(sex,age_range,contains("inadequate"),contains("gap"),-contains("_se"))

age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
      "Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_fat$age_range<-reorder.factor(w_fat$age_range,new.order=age)
#w_fat[w_fat==0]<-as.numeric(NA)
#w_fat[is.na(w_fat)]<-""

w_fat=w_fat%>%
  arrange(age_range)%>%
mutate_at(vars(contains("gap")),funs(scales::percent(.,accuracy=.1)))%>%
mutate_at(vars(contains("inadequate")),funs(scales::percent(.,accuracy=.1)))%>%
  dplyr::select(1:2,contains("actual_inadequate"),contains("share_inadequate"),contains("actual_gap"),contains("share_gap"))



fat_print<-kable(w_fat,booktabs=TRUE,caption="Incidence of Fat Inadequacy",
      col.names=c("Sex","Age Range",rep(list("India","IOM","IOM"),4)),
      escape=F)%>%
  kable_styling(full_width=FALSE,"striped","bordered")%>% 
    add_header_above(c(" "=2,rep(list("wrt Age Group Req"=2,"wrt Individual Req"=1),4)))%>% 
  add_header_above(c(" "=2,rep(list("Reported Individual Consumption"=3,"Allocated Household Consumption"=3),2)))%>% 
add_header_above(c(" "=2,"Frequency of Inadequacy"=6, "Intensity of Inadequacy"=6))%>% 
   column_spec(c(2,8,14),border_right = TRUE)%>%
 footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
          Consumption share is equal to individual Adult Equivalents/Total Household Adult Equivalents.
          India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
          WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
          IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")


save_kable(fat_print,"fat.png")
print(fat_print)


#carb
carb_inadequacy=carb_inadequacy%>%
  dplyr::rename("carb_IOM"="carb_amdr_lower","carb_IOM2"="carb_amdr2")
cref=c("IOM","IOM2")

for (j in cref){
  #actual reported consumption inadequacy
  carb_inadequacy[[paste0("actual_inadequate_",j)]]<-if_else(carb_inadequacy$I_carb<carb_inadequacy[[paste0("carb",sep="_",j)]],1,0)
  carb_inadequacy[[paste0("actual_gap_",j)]]<-if_else(carb_inadequacy[[paste0("actual_inadequate_",j)]]==1,(carb_inadequacy$I_carb-carb_inadequacy[[paste0("carb",sep="_",j)]])/carb_inadequacy[[paste0("carb",sep="_",j)]],as.numeric(NA))
  
  #share allocation inadequacy
  carb_inadequacy[[paste0("share_inadequate_",j)]]<-if_else(carb_inadequacy[[paste0("I_share_",j,"_carb")]]<carb_inadequacy[[paste0("carb",sep="_",j)]],1,0)
  carb_inadequacy[[paste0("share_gap_",j)]]<-if_else(carb_inadequacy[[paste0("share_inadequate_",j)]]==1,(carb_inadequacy[[paste0("I_share_",j,"_carb")]]-carb_inadequacy[[paste0("carb",sep="_",j)]])/carb_inadequacy[[paste0("carb",sep="_",j)]],as.numeric(NA))
  
}


w_carb=carb_inadequacy%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,age_range)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(sex,age_range,contains("inadequate"),contains("gap"),-contains("_se"))


age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
      "Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_carb$age_range<-reorder.factor(w_carb$age_range,new.order=age)
#w_carb[w_carb==0]<-as.numeric(NA)
#w_carb[is.na(w_carb)]<-""

w_carb=w_carb%>%
  arrange(age_range)%>%
mutate_at(vars(contains("gap")),funs(scales::percent(.,accuracy=.1)))%>%
mutate_at(vars(contains("inadequate")),funs(scales::percent(.,accuracy=.1)))%>%
  dplyr::select(1:2,contains("actual_inadequate"),contains("share_inadequate"),contains("actual_gap"),contains("share_gap"))



carb_print<-kable(w_carb,booktabs=TRUE,caption="Incidence of Carbohydrate Inadequacy",
      col.names=c("Sex","Age Range",rep(list("IOM","IOM"),4)),
      escape=F)%>%
  kable_styling(full_width=FALSE,"striped","bordered")%>% 
    add_header_above(c(" "=2,rep(list("wrt Age Group Req"=1,"wrt Individual Req"=1),4)))%>% 
  add_header_above(c(" "=2,rep(list("Reported Individual Consumption"=2,"Allocated Household Consumption"=2),2)))%>% 
add_header_above(c(" "=2,"Frequency of Inadequacy"=4, "Intensity of Inadequacy"=4))%>% 
   column_spec(c(2,6,10),border_right = TRUE)%>%
 footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
          Consumption share is equal to individual Adult Equivalents/Total Household Adult Equivalents.
          India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
          WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
          IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")


save_kable(carb_print,"carb.png")
print(carb_print)



```





13. Individual inadequacy by comparing actual consumption to target (BY REFERENCE SOURCE)
```{r I_indequality}

setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Programs/R/output")



#India standards
India_inadequacy=w.I.roster.2015%>%
  dplyr::select(1:23,33:39,contains("India"))%>%
  mutate(kcal_inadequate=if_else(I_kcal<kcal_India,1,0),
         protein_inadequate=if_else(I_protein<protein_India,1,0),
         fat_inadequate=if_else(I_fat<fat_India,1,0),
         calcium_inadequate=if_else(I_calcium<calcium_India,1,0),
         iron_inadequate=if_else(I_iron<iron_India,1,0))%>%
   mutate(kcal_gap_India=if_else(kcal_inadequate==1,(I_kcal-kcal_India)/kcal_India,as.numeric(NA)),
         protein_gap_India=if_else(protein_inadequate==1,(I_protein-protein_India)/protein_India,as.numeric(NA)),
         fat_gap_India=if_else(fat_inadequate==1,(I_fat-fat_India)/fat_India,as.numeric(NA)),
         calcium_gap_India=if_else(calcium_inadequate==1,(I_calcium-calcium_India)/calcium_India,as.numeric(NA)),
         iron_gap_India=if_else(iron_inadequate==1,(I_iron-iron_India)/iron_India,as.numeric(NA)))%>%
  dplyr::select(vcode,dvcode,popweightR2,sex,range_India,contains("kcal"),contains("protein"),contains("fat"),contains("calcium"),contains("iron"))

India_w=India_inadequacy%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,range_India)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(-(3:8),-contains("_se"))

age=c("1-3","4-6","7-9","10-12","13-15","16-17","18-120")
India_w$range_India<-reorder.factor(India_w$range_India,new.order=age)

India_w=India_w%>%
  arrange(range_India)%>%
mutate_at(vars(contains("gap")),funs(scales::percent(.,accuracy=.1)))%>%
mutate_at(vars(contains("inadequate")),funs(scales::percent(.,accuracy=.1)))%>%
  mutate_at(vars(c(4,8,12,contains("I_"))),funs(round(.,2)))

    
India_print<-kable(India_w,booktabs=TRUE,caption="Individual Nutrient Inadequacy using India Standards",
      col.names=c("Sex","Age Range",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity"),
      escape=F)%>%
  kable_styling("striped",full_width=FALSE)%>%     
add_header_above(c(" "=2,"Energy (kcal/day)"=4, "Protein (g/day)"=4,"Fat (g/day)"=4, "Calcium (mg/day)"=4,
                   "Iron (mg/day)"=4)) %>% 
   column_spec(c(2,6,10,14,18),border_right = TRUE)%>%
  #row_spec(3:4,background="gray")%>%
 footnote(general="Inadequacy Frequency is Proportion of Sex/Age group that consumed below the requirement. 
          Inadequacy Severity is the percent of below the requirement of the average intake. 
          Means are weighted using IFPRI sample weights.")

#save_kable(India_print,"India_inadequacy.pdf")
print(India_print)


#FAO standards
FAO_inadequacy=w.I.roster.2015%>%
  dplyr::select(1:23,33:39,contains("FAO"))%>%
   mutate(kcal_inadequate=if_else(I_kcal<kcal_FAO,1,0),
         protein_inadequate=if_else(I_protein<protein_FAO,1,0))%>%
  mutate(kcal_gap_FAO=if_else(kcal_inadequate==1,(I_kcal-kcal_FAO)/kcal_FAO,as.numeric(NA)),
         protein_gap_FAO=if_else(protein_inadequate==1,(I_protein-protein_FAO)/protein_FAO,as.numeric(NA)))%>%
  dplyr::select(vcode,dvcode,popweightR2,sex,range_FAO,contains("kcal"),contains("protein"))

FAO_w=FAO_inadequacy%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,range_FAO)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(-(3:8),-contains("_se"))

age=c("1-4","4-9","9-14","14-18","18-30","30-60","60-150")
FAO_w$range_FAO<-reorder.factor(FAO_w$range_FAO,new.order=age)

FAO_w=FAO_w%>%
  arrange(range_FAO)%>%
mutate_at(vars(contains("gap")),funs(scales::percent(.,accuracy=.1)))%>%
mutate_at(vars(contains("inadequate")),funs(scales::percent(.,accuracy=.1)))%>%
  mutate_at(vars(c("kcal_FAO",contains("I_"))),funs(round(.,2)))%>%
  filter(!is.na(range_FAO))%>%
  mutate_at(vars(c("protein_inadequate","protein_gap_FAO")),funs(revalue(.,c("0.0%"=as.character(NA)))))%>%
mutate(protein_FAO=if_else(protein_FAO==0,as.numeric(NA),round(protein_FAO,2)))

          
FAO_print<-kable(FAO_w,booktabs=TRUE,caption="Individual Nutrient Inadequacy using FAO/WHO Standards",
      col.names=c("Sex","Age Range",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity"),
      escape=F)%>%
  kable_styling("striped",full_width=FALSE)%>%     
add_header_above(c(" "=2,"Energy (kcal/day)"=4, "Protein (g/day)"=4))%>% 
   column_spec(c(2,6,10),border_right = TRUE)%>%
  #row_spec(c(1,14),hline_after= T)%>%
 footnote(general="Inadequacy Frequency is Proportion of Sex/Age group that consumed below the requirement. 
          Inadequacy Severity is the percent of below the requirement of the average intake. 
          Means are weighted using IFPRI sample weights.")

#save_kable(FAO_print,"FAO_inadequacy.pdf")
print(FAO_print)




#IOM standards
IOM_inadequacy=w.I.roster.2015%>%
  dplyr::select(1:23,33:39,contains("IOM"),contains("amdr"))%>%
   mutate(kcal_inadequate=if_else(I_kcal<kcal_IOM,1,0),
         protein_inadequate=if_else(I_protein<protein_amdr_lower,1,0),
          carb_inadequate=if_else(I_carb<carb_amdr_lower,1,0),
         fat_inadequate=if_else(I_fat<fat_amdr_lower,1,0),
         calcium_inadequate=if_else(I_calcium<calcium_IOM,1,0),
         iron_inadequate=if_else(I_iron<iron_IOM,1,0))%>%
  mutate(kcal_gap_IOM=if_else(kcal_inadequate==1,(I_kcal-kcal_IOM)/kcal_IOM,as.numeric(NA)),
         calcium_gap_IOM=if_else(calcium_inadequate==1,(I_calcium-calcium_IOM)/calcium_IOM,as.numeric(NA)),
         iron_gap_IOM=if_else(iron_inadequate==1,(I_iron-iron_IOM)/iron_IOM,as.numeric(NA)),
         protein_gap_IOM=if_else(protein_inadequate==1,(I_protein-protein_amdr_lower)/protein_amdr_lower,as.numeric(NA)),
         carb_gap_IOM=if_else(carb_inadequate==1,(I_carb-carb_amdr_lower)/carb_amdr_lower,as.numeric(NA)),
         fat_gap_IOM=if_else(fat_inadequate==1,(I_fat-fat_amdr_lower)/fat_amdr_lower,as.numeric(NA)))%>%
 dplyr::select(vcode,dvcode,popweightR2,sex,range_IOM,contains("kcal"),contains("protein"),contains("carb"),contains("fat"),contains("calcium"),contains("iron"),-contains("upper"),-protein_IOM)


IOM_w=IOM_inadequacy%>%
  as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
  group_by(sex,range_IOM)%>%
  summarise_all(survey_mean,na.rm=TRUE)%>%
  dplyr::select(-(3:8),-contains("_se"))

age=c("2-3","4-8","9-13","14-18","19-30","31-50","51-69","70-150")
IOM_w$range_IOM<-reorder.factor(IOM_w$range_IOM,new.order=age)

IOM_w=IOM_w%>%
  arrange(range_IOM)%>%
mutate_at(vars(contains("gap")),funs(scales::percent(.,accuracy=.1)))%>%
mutate_at(vars(contains("inadequate")),funs(scales::percent(.,accuracy=.1)))%>%
  mutate(sex=as.character(sex))%>%
  mutate_if(is.numeric,funs(round(.,2)))%>%
  filter(!is.na(range_IOM))


IOM_print<-kable(IOM_w,booktabs=TRUE,caption="Individual Nutrient Inadequacy using IOM Standards",
      col.names=c("Sex","Age Range",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity",
            "Actual Individual Consumption","Requirement","Inadequacy Frequency","Inadequacy Severity"),
      escape=F)%>%
 kable_styling("striped",full_width=FALSE)%>%    
add_header_above(c(" "=2,"Energy (kcal/day)"=4, "Protein (g/day)"=4,"Carb (g/day)"=4,"Fat (g/day)"=4, "Calcium (mg/day)"=4,
                   "Iron (mg/day)"=4)) %>% 
   column_spec(c(2,6,10,14,18,22),border_right = TRUE)%>%
 # row_spec(c(1,16),hline_after= T)%>%
 footnote(general="Inadequacy Frequency is Proportion of Sex/Age group that consumed below the requirement. 
          Inadequacy Severity is the percent of below the requirement of the average intake. 
          Means are weighted using IFPRI sample weights.")

#save_kable(IOM_print,"IOM_inadequacy.pdf")
print(IOM_print)





```



