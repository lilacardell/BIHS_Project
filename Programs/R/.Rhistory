dplyr::select(-1)
#join India requirements (all are using ref weight and height, and assume moderate activity for under 18 p66 Inida (2009))
#task: unselect agemin and agemax in w.I roster.2015
w.I.roster.2015=w.I.roster.2015%>%
#select(!c("agemin","agemax"))%>%
mutate(activityI=if_else(age>=18,activity,"moderate"))%>%
fuzzy_left_join(India_RDA,
by=c("sex","activityI"="activity","age"="agemin", "age"="agemax"),
match_fun=list(`==`,`==`,`>=`, `<=`))%>%
dplyr::rename(activity=activity.x,sex=sex.x,weight_India_grp=refwt_India)%>%
mutate(age_grp_India=if_else(!is.na(agemin),paste(as.character(agemin),as.character(agemax),sep="-"),as.character(NA)),
kcal_India_grp=if_else(pregnant==1,kcal_India+350,if_else(lactating==1,kcal_India+560,kcal_India))
,protein_rda_India=if_else(pregnant==1,protein_rda_India+23,if_else(lactating==1,protein_rda_India+16,protein_rda_India)),
#calcium_rda_India=if_else(porl==1,1200,calcium_rda_India),
#iron_rda_India=if_else(porl==1,21,iron_rda_India)
)%>%
dplyr::select(-contains(".y"),-agemin,-agemax,-calcium_rda_India,-iron_rda_India,-kcal_India)
#task : the columns of w.I roster.2015 are different from those of  w.I roster.2011
rm(list=ls(pattern="India"))
setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards")
#FAO weight height
hfa_girls_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_girls_25",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
filter(year%in%(2:4))%>%
mutate(h_med=h_P50)
wfa_girls_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_girls_05",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
filter(year%in%(2:4))%>%
mutate(w_med=w_P50)
girls_24=left_join(hfa_girls_24,wfa_girls_24,by=c("sex","year","month"))
hfa_girls_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_girls_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
mutate(h_med=h_P50)
wfa_girls_510 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_girls_510",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
mutate(w_med=w_P50)
bmi_girls_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="bmi_girls_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("b",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("b_P"))%>%
mutate(b_med=b_P50)
girls_519=left_join(hfa_girls_519,wfa_girls_510,by=c("sex","year","month"))%>%
left_join(bmi_girls_519,by=c("sex","year","month"))%>%
mutate(w_med=if_else(is.na(w_med),b_med*(h_med/100)^2,w_med))
girls=bind_rows(girls_24,girls_519)
girls_19=girls%>%
filter(year==19)%>%
dplyr::select(contains("med"))
women_20=tibble(year=seq(20,120,1),sex=2,h_med=girls_19$h_med,w_med=girls_19$w_med)
FAO_women=bind_rows(girls,women_20)%>%
mutate(w_med=if_else(is.na(w_med)&year<19,b_med*(h_med/100)^2,w_med))%>%
group_by(sex,year)%>%
dplyr::summarise(across(everything(),median,na.rm=TRUE))%>%
dplyr::select(-month)%>%
mutate(pregnant=0,lactating=0)
FAO_women_med=FAO_women%>%
dplyr::select(sex,year,contains("_med"),pregnant,lactating)
for(i in 14:50){
x=FAO_women_med%>%
filter(year==i)%>%
mutate(pregnant=1,b_med=as.numeric(NA),w_med=w_med+13.25)
y=FAO_women_med%>%
filter(year==i)%>%
mutate(lactating=1)
FAO_women_med=rbind(FAO_women_med,x,y)
}
rm(list=ls(pattern="girls"),women_20,x,y)
hfa_boys_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_boys_25",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
filter(year%in%(2:4))%>%
mutate(h_med=h_P50)
wfa_boys_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_boys_05",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
filter(year%in%(2:4))%>%
mutate(w_med=w_P50)
boys_24=left_join(hfa_boys_24,wfa_boys_24,by=c("sex","year","month"))
hfa_boys_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_boys_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
mutate(h_med=h_P50)
wfa_boys_510 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_boys_510",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
mutate(w_med=w_P50)
bmi_boys_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="bmi_boys_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("b",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("b_P"))%>%
mutate(b_med=b_P50)
boys_519=left_join(hfa_boys_519,wfa_boys_510,by=c("sex","year","month"))%>%
left_join(bmi_boys_519,by=c("sex","year","month"))%>%
mutate(w_med=if_else(is.na(w_med),b_med*(h_med/100)^2,w_med))
boys=bind_rows(boys_24,boys_519)
boys_19=boys%>%
filter(year==19)%>%
dplyr::select(contains("med"))
men_20=tibble(year=seq(20,120,1),sex=1,h_med=boys_19$h_med,w_med=boys_19$w_med)
FAO_men=bind_rows(boys,men_20)%>%
mutate(w_med=if_else(is.na(w_med)&year<19,b_med*(h_med/100)^2,w_med))%>%
group_by(sex,year)%>%
dplyr::summarise(across(everything(),median,na.rm=TRUE))%>%
dplyr::select(-month)%>%
mutate(pregnant=0,lactating=0)
FAO_men_med=FAO_men%>%
dplyr::select(sex,year,contains("_med"),pregnant,lactating)
rm(list=ls(pattern="boys"),men_20)
FAO_hwb=bind_rows(FAO_women,FAO_men)
FAO_hwb_med=bind_rows(FAO_women_med,FAO_men_med)%>%
mutate(age_grp_FAO=if_else(year%in%(4:8),"4-8",if_else(year%in%(9:13),"9-13",if_else(year%in%(14:18),"14-18",if_else(year%in%(19:30),"19-30",if_else(year%in%(31:50),"31-50",if_else(year%in%(51:69),"51-69",if_else(year>=70,"70 and over",as.character(year)))))))))%>%
rename(age=year)%>%
group_by(sex,age_grp_FAO)%>%
mutate(h_FAO_grp=median(h_med),w_FAO_grp=median(w_med))%>%
rename(h_FAO=h_med,w_FAO=w_med,b_FAO=b_med)
rm(list=ls(pattern="men"))
#read in energy requirement formulas
FAO_adult <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="Adult_BMRPAL",range = "A1:M37",col_names = TRUE)%>%
dplyr::select(1:6,9:11,13)%>%
mutate(sex=if_else(sex=="Male",1,2))%>%
filter(agemin>=18)
FAO_child <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="Child_TEEPAL",range = "A1:P97",col_names = TRUE)%>%
mutate(sex=if_else(sex=="Male",1,2))%>%
dplyr::select(1:6,11,13,14,16)
FAO=bind_rows(FAO_adult,FAO_child)
FAO_energy=FAO_hwb_med%>%
fuzzy_left_join(FAO,by=c("sex"="sex","age"="agemin","age"="agemax"),match_fun=list(`==`,`>=`,`<`))%>%
rename(sex=sex.x)%>%
dplyr::select(-sex.y,-agemin,-agemax)%>%
mutate(protein_FAO_age=if_else(pregnant==1,protein_FAO_perkg*w_FAO+14,
if_else(lactating==1,protein_FAO_perkg*w_FAO+15.75,
protein_FAO_perkg*w_FAO)),
kcal_FAO_age=if_else(pregnant==1,multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp)+285,
if_else(lactating==1,multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp)+485,
multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp))),
kcal_FAO_grp=if_else(pregnant==1,multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp)+285,
if_else(lactating==1,multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp)+485,
multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp))))%>%
dplyr::rename(weight_FAO_age=w_FAO,height_FAO_age=h_FAO,weight_FAO_grp=w_FAO_grp,height_FAO_grp=h_FAO_grp,BMI_FAO_age=b_FAO)
base_FAO=FAO_energy%>%
filter(age==18,sex==1,activity=="moderate")
base_kcal_FAO=base_FAO$kcal_FAO_age
#join FAO standards with roster
#calculate energy and protein requirements using reference and individual weights, activity adjustments for everyone
w.I.roster.2015=w.I.roster.2015%>%
mutate(sex=as.numeric(sex))%>%
left_join(FAO_energy,by=c("sex","age","activity","pregnant","lactating"))%>%
mutate(kcal_FAO_I=if_else(pregnant==1,multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp)+285,
if_else(lactating==1,multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp)+485,
multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp))),
AE_FAO_I=kcal_FAO_I/base_kcal_FAO,AE_FAO_age=kcal_FAO_age/base_kcal_FAO,AE_FAO_grp=kcal_FAO_grp/base_kcal_FAO,
BMI_FAO_age=if_else(age>18,21.5,BMI_FAO_age))%>%
dplyr::select(-(kc:multiplier))
rm(list=ls(pattern="FAO"))
library(plyr)
#DRI standards
#energy requirements
IOM_energy <- read_excel("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards/IOM_requirements.xlsx",sheet="Energy_IOM",range = "A1:R97",col_names = TRUE)%>%
mutate(sex=if_else(sex=="Male",1,2),activity=revalue(PA_level,c("sedentary"="light","low active"="light","active"="moderate","very active"="heavy")),pregnant=if_else(lifestage=="Pregnancy",1,0),lactating=if_else(lifestage=="Lactation",1,0))%>%
dplyr::select(-1,-2,-PA_level,-age_refmean,-EER_eq)%>%
dplyr::rename(agemin=age_lower_yrs,agemax=age_upper_yrs,kcal_IOM_grp=EER_IOM_ref,height_IOM_grp=refht_IOM,weight_IOM_grp=refwt_IOM)%>%
group_by(sex,agemin,agemax,activity,pregnant,lactating)%>%
dplyr::summarise_all(mean)%>%
ungroup()%>%
mutate(agemax=as.numeric(agemax))%>%
mutate(agemax=if_else(is.na(agemax),150,agemax))
#nutrient requirements
IOM_nutrients <- read_excel("/Users/juli/Desktop/BIHS/master/BIHS_Project/Data/Clean Data/nutrient standards/IOM_requirements.xlsx",sheet="Nutrients",range = "A1:T23",col_names = TRUE)%>%
#dplyr::select(-9,-11)%>%
mutate(sex=if_else(sex=="Male",1,2),pregnant=if_else(lifestage=="Pregnancy",1,0),lactating=if_else(lifestage=="Lactation",1,0))%>%
dplyr::rename(agemin=age_lower_yrs,agemax=age_upper_yrs,calcium_rda_IOM=calcium_rda,calcium_ear_IOM=calcium_ear,
iron_rda_IOM=iron_rda,iron_ear_IOM=iron_ear,
carb_IOM_ear=carb_ear,carb_IOM_rda=carb_rda,carb_IOM_lower=carbohydrate_lower,carb_IOM_upper=carbohydrate_upper,
protein_IOM_lower=protein_lower,protein_IOM_upper=protein_upper,protein_rda_IOM=protein_rda,
fat_IOM_lower=lipids_lower,fat_IOM_upper=lipids_upper)%>%
dplyr::select(-lifestage,-refht_IOM,-refwt_IOM)
base_IOM=IOM_energy%>%
filter(agemin==19,sex==1,activity=="moderate")
base_kcal_IOM=base_IOM$kcal_IOM_grp
#join DRI energy standards with roster (calculate individual and reference requirements, everyone has activity adjustments)
w.I.roster.2015=w.I.roster.2015%>%
fuzzy_left_join(IOM_energy,by=c("sex","age"="agemin", "age"="agemax","activity","pregnant","lactating"),match_fun=list(`==`,`>=`, `<=`,`==`,`==`,`==`))%>%
dplyr::rename(sex=sex.x,activity=activity.x,pregnant=pregnant.x,lactating=lactating.x)%>%
mutate(age_grp_IOM=if_else(!is.na(agemin),paste(as.character(agemin),as.character(agemax),sep="-"),as.character(NA)))%>%
mutate(kcal_IOM_I=eer1-(eer2*age)+refPA*((eer3*weight)+(eer4*height/100))+eer5+eer6)%>%
mutate(AE_IOM_grp=kcal_IOM_grp/base_kcal_IOM,AE_IOM_I=kcal_IOM_I/base_kcal_IOM)%>%
dplyr::select(-contains(".y"),-agemin,-agemax,-refPA,-contains("eer"))
#generate individual and reference nutrient standards for IOM
w.I.roster.2015=w.I.roster.2015%>%
fuzzy_left_join(IOM_nutrients,by=c("sex","age"="agemin","age"="agemax","pregnant","lactating"), match_fun=list(`==`,`>=`, `<=`,`==`,`==`))%>%
dplyr::rename(sex=sex.x,pregnant=pregnant.x,lactating=lactating.x)%>%
mutate(protein_ear_IOM_grp=protein_ear_perkg*weight_IOM_grp,protein_ear_IOM_I=protein_ear_perkg*weight)%>%
dplyr::select(-contains(".y"),-protein_ear_perkg,-agemin,-agemax)
xlist=c("protein","carb")
ylist=c("lower","upper")
#zlist=c("grp","I")
for (x in xlist){
for (y in ylist){
# for (z in zlist){
w.I.roster.2015[[paste(x,y,"IOM_grp",sep="_")]]<-  (w.I.roster.2015[[paste(x,"IOM",y,sep="_")]]/100)*w.I.roster.2015[[paste("kcal_IOM_grp",sep="_")]]/4
#}
}
}
xlist=c("fat")
ylist=c("lower","upper")
#zlist=c("grp","I")
for (x in xlist){
for (y in ylist){
# for (z in zlist){
w.I.roster.2015[[paste(x,y,"IOM_grp",sep="_")]]<-  (w.I.roster.2015[[paste(x,"IOM",y,sep="_")]]/100)*w.I.roster.2015[[paste("kcal_IOM_grp",sep="_")]]/9
#}
}
}
w.I.roster.2015=w.I.roster.2015%>%
dplyr::select(-contains("IOM_upper"),-contains("IOM_lower"))
rm(list=ls(pattern="IOM"),x,y,z,xlist,ylist,zlist)
#reference weights and heights
ref_wtht = w.I.roster.2015%>%
dplyr::select(hhid,mid,sex,sampletype,age,contains("age_grp"),pregnant,lactating,contains("weight"),contains("height"),contains("code"),contains("R2"))
#add back HH-level variables and generate hh level variables
hh=w.I.roster.2015%>%
dplyr::select(hhid,contains("AE"),-aeu)%>%
group_by(hhid)%>%
dplyr::summarise_all(sum,na.rm=TRUE)%>%
dplyr::rename_at(.vars=vars(2:7),.funs=funs(sub("AE_","hhsize_",.)))
w.hh.roster.2015=left_join(w.hh.roster.2015,hh,by="hhid")
h=w.hh.roster.2015%>%
dplyr::select(hhid,contains("hhsize_"),contains("hh_"),AE_OECD,hhds,nofood,hungryday,hungrynight)%>%
dplyr::rename(hhsize_OECD=AE_OECD)
#task: w.I.roster.2015 does not have column named "hhsize_IOM_grp"
w.I.roster.2015=left_join(w.I.roster.2015,h,by="hhid")%>%
mutate(share_India_grp=AE_India_grp/hhsize_India_grp,share_FAO_grp=AE_FAO_grp/hhsize_FAO_grp,share_IOM_grp=AE_IOM_grp/hhsize_IOM_grp,share_FAO_I=AE_FAO_I/hhsize_FAO_I,share_IOM_I=AE_IOM_I/hhsize_IOM_I,share_FAO_age=AE_FAO_age/hhsize_FAO_age,
age_range=if_else(age>=2&age<4,"Toddler (2-3)",
if_else(age>=4&age<8,"Young Child (4-7)",
if_else(age>=8&age<11,"Older Child (8-10)",
if_else(age>=11&age<14,"Young Adolescent (11-13)",
if_else(age>=14&age<18,"Older Adolescent (14-17)",
if_else(age>=18&age<30,"Young Adult (18-29)",
if_else(age>=30&age<=60,"Adult (30-59)",
if_else(age>60,"Older Adult (60+)",as.character(NA))))))))))
rm(h,hh,i)
# ## SUMMARY TABLES FOR D&T SUBSET
# # "we restrict the sample to households with male, married heads whose spouses are present and to
# # households without pregnant or lactating women. This sample of 3,060 house-holds..." (page 631)
#
# ##DST TABLE 1
# roster_hh_DST = wroster_2015_hh %>%
#   filter(sexhead==1 & maritalhead==2 & abroadhead==0 & poly==0 & porl_hh==0 & spouseabroad_hh==0)
#
# #nrow(filter(roster_hh_DST,is.na(BMIhead))) #86 missing
# #nrow(filter(roster_hh_DST,is.na(BMIspouse))) #45 missing
#
# design_hh_DT <- svydesign(data=roster_hh_DST,id=~vcode, strata=~dvcode,weights=~hhweightR1)
#
# listx = dplyr::select(roster_hh_DST,22,53,63,66,2,19,20,6,7,8,33,37:42,43,46:51)
# a=svymean(listx,design_hh_DT,na.rm=TRUE)
# print(ftable(a),digits=2)
#
# #this is not weighted, use svymean for weighted results
# roster_hh_DST.summary = roster_hh_DST %>%
#   psych::describe() %>%
#   as_tibble(rownames="rowname") %>%
#   dplyr::select(rowname,n,mean,sd)
#
# #print(roster_hh_DST.summary,digits=3)
# #
# # table1= dplyr::bind_cols(roster_2015_hh.summary,roster_hh_DST.summary) %>%
# #   dplyr::select(-rowname1)%>%
# #   dplyr::rename(obs_full=n,mean_full=mean,sd_full=sd,obs_sample=n1,mean_sample=mean1,sd_sample=sd1) %>%
# #   dplyr::filter(rowname=="hhdaycalperAE" |rowname=="hhdayecalperAE" | rowname=="nonfoodexp_hhwkpc" | rowname=="foodpurch_hhwkpc" | rowname=="foodshare" | rowname=="hhsize" | rowname=="AE" | rowname=="boy" | rowname=="girl" | rowname=="otheradult"
# #                 | rowname=="agehead" |rowname=="lithead" |rowname=="noschoolhead" |rowname=="secondschoolhead" |rowname=="agworkhead" |rowname=="BMIhead"
# #                 | rowname=="agespouse" |rowname=="litspouse" |rowname=="noschoolspouse" |rowname=="secondschoolspouse" |rowname=="agworkspouse" |rowname=="BMIspouse")
# #
# #
# # kable(table1,booktabs=TRUE,digits=2,caption="Table 1", col.names=c("Variable","N","Mean","SD","N","Mean","SD"),align='r')%>%
# #   kable_styling(full_width=TRUE)%>%
# #   pack_rows("Household Head",8,13)%>%
# #   pack_rows("Spouse",14,19)%>%
# #   pack_rows("Expenditures",20,22)%>%
# #   add_header_above(c(" "=1,"All Households"=3,"D&T Sample"=3))
# #
#
# ###TABLE 3
# roster_I_DST=wroster_2015_I%>%
#   filter(sexhead==1 & maritalhead==2 & abroadhead==0 & poly==0 & porl_hh==0 & spouseabroad_hh==0)%>%
#   mutate(BMIunder=if_else(BMI<18.5,(18.5-BMI)/18.5,0),
#          adultgrp=if_else(relation==1,"head",if_else(relation==2,"spouse",if_else(otheradult==1,"otheradult",as.character(NA)))))%>%
#    filter(!is.na(agegrp_DST),!is.na(BMI),!is.na(adultgrp))%>%
#   dplyr::select(hhid,mid,agegrp_DST,adultgrp,BMI,BMIunder,vcode,dvcode,popweightR1)
#
# #%>%
#  # reshape2::cast(agegrp~adultgrp,fun.aggregate=c(mean,sd,n))
#
# #roster_I_DST$DST[is.na(roster_I_DST$DST)]<-0 #convert zero to NA
# design_I_DT <- svydesign(data=roster_I_DST,id=~vcode, strata=~dvcode,weights=~popweightR1)
#
# table3= roster_I_DST %>%
#   group_by(agegrp_DST,adultgrp) %>%
#   summarise(mean=mean(BMIunder),se=sd(BMIunder)/sqrt(length(BMIunder)),n=n())%>%
#   reshape2::melt(id.vars=c("agegrp_DST","adultgrp"),measure.var=c("mean","se","n"))%>%
#   dplyr::arrange(agegrp_DST)%>%
#   unite(agegrp_DST,variable,col="agegrp_DST_var",sep="_")%>%
#   dcast(agegrp_DST_var~adultgrp,value.var = "value")%>%
#   separate(agegrp_DST_var,into=c("agegrp_DST","var"),"_")%>%
#   dplyr::select(var,head,spouse,otheradult)
# #
# #
# # kable(table3,booktabs=TRUE,digits=3,caption="Table 3: BMI Shortfalls", col.names=c("","Heads","Spouses","Other Adults"),align='r')%>%
# #   kable_styling(full_width=TRUE)%>%
# #   pack_rows("Ages 20-39",1,3)%>%
# #   pack_rows("Ages 40-59",4,6)%>%
# #   pack_rows("Ages 60 and up",7,9)
#
# #%>%
#  # add_header_above(c(" "=1,"All Households"=3,"D&T Sample"=3))
options(digits=3,knitr.kable.NA = '')
setwd("/Users/juli/Desktop/BIHS/master/BIHS_Project/Programs/R/output")
#task: cannot find the vcode in w.I.roster.2015
#compare reference weights by age group
allref=w.I.roster.2015%>%
mutate(weight_India_grp_b=if_else(weight<weight_India_grp,1,0),
weight_FAO_grp_b=if_else(weight<weight_FAO_grp,1,0),
weight_FAO_age_b=if_else(weight<weight_FAO_age,1,0),
weight_IOM_grp_b=if_else(weight<weight_IOM_grp,1,0),
height_FAO_grp_b=if_else(height<height_FAO_grp,1,0),
height_FAO_age_b=if_else(height<height_FAO_age,1,0),
height_IOM_grp_b=if_else(height<height_IOM_grp,1,0),
sex=as.factor(sex))%>%
dplyr::select(hhid,mid,age,age_range,sex,contains("weight"),contains("height"),contains("AE_"),contains("code"),contains("R2"))
w_allref=allref%>%
as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
group_by(sex,age_range)%>%
summarise_all(survey_mean,na.rm=TRUE)%>%
dplyr::select(-contains("code"),-contains("R2"),-contains("hhid"),-contains("mid"),-contains("_se"))
w=allref%>%
group_by(sex,age_range)%>%
dplyr::summarise(n=n())
w_allref=left_join(w_allref,w,by=c("sex","age_range"))
age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
"Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_allref$age_range<-reorder.factor(w_allref$age_range,new.order=age)
levels(w_allref$sex)<-list("Male"="1","Female"="2")
graph_allref=w_allref%>%
arrange(age_range)%>%
mutate_at(vars(contains("_b")),funs(.*100))%>%
pivot_longer(cols=weight:AE_IOM_I,names_to=c("variable","source","reflevel","pct"),names_sep="_",values_drop_na = TRUE)%>%
mutate(source=if_else(is.na(source),"sample",source),reflevel=if_else(is.na(reflevel),"sample",if_else(reflevel=="I","sample",reflevel)), sourceref=paste(source,reflevel,sep="_"))
x.label=c("Toddler \n (2-3)","Young Child \n (4-7)","Older Child \n (8-10)","Young Adolescent \n (11-13)","Older Adolescent \n (14-17)",
"Young Adult \n (18-29)","Adult \n (30-59)","Older Adult \n (60+)")
sr=unique(graph_allref$sourceref)
wha=c("sample_sample","India_grp","FAO_age","FAO_grp","IOM_grp","FAO_sample","IOM_sample")
lbl=c("Sample", "India (age group)","WHO (age)","WHO (age group)","IOM (age group)","WHO (sample wt/ht)","IOM (sample wt/ht)")
clr=c("black","green","blue","blue","red","blue","red")
lnt=c("dotted","solid","dashed","solid","solid","dashed","dashed")
w=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable=="weight"),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
scale_y_continuous(name="Weight (kg)",limits=c(0,80),breaks=seq(0,80,10),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)))+theme(legend.position=c(0.6,0.75),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(w)
ggsave("refweight_plot.png")
h=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable=="height"),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
scale_y_continuous(name="Height (cm)",limits=c(0,200),breaks=seq(0,200,20),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)))+theme(legend.position=c(0.6,0.75),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(h)
ggsave("refheight_plot.png")
hw=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable%in%c("weight","height")),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
#scale_y_continuous(name="Height (cm)",limits=c(0,200),breaks=seq(0,200,20),expand=c(0,0))+
scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)),rows=vars(factor(variable)),scales="free_y")+theme(legend.position=c(0.6,0.75),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
a=ggplot()+geom_path(data=subset(graph_allref,is.na(pct)&variable=="AE"),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1.5)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
scale_y_continuous(name="Adult Equivalents",limits=c(0,1.5),breaks=seq(0,1.5,0.1),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(sex)))+theme(legend.position=c(0.5,0.75),legend.background=element_rect(size=0.75,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(a)
ggsave("AE_plot.png")
wtht_allref=w_allref%>%
arrange(age_range)%>%
mutate_at(vars(contains("_b")),funs(scales::percent(.,accuracy=.01)))%>%
dplyr::select(sex,age_range,age,weight,contains("weight_India_grp"),contains("weight_FAO_age"),contains("weight_FAO_grp"),contains("weight_IOM_grp"),height,contains("height_FAO_age"),contains("height_FAO_grp"),contains("height_IOM_grp"))
AE_allref=w_allref%>%
arrange(age_range)%>%
dplyr::select(sex,age_range,age,AE_FAO_I,AE_IOM_I,AE_FAO_age,AE_India_grp,AE_FAO_grp,AE_IOM_grp,n)
whref_print<-kable(wtht_allref,booktabs=TRUE,caption="Comparison of Reference Standards for Weight and Height",
col.names=c("Sex","Age Range","Age","Sample","Reference Group","% Below","Reference Age","% Below","Reference Group","% Below","Reference Group","% Below","Sample","Reference Age","% Below","Reference Group","% Below","Reference Group","% Below"),
escape=F)%>%
kable_styling(full_width=FALSE,"striped")%>%
add_header_above(c(" "=3," "=1,"India"=2, "WHO/FAO"=4,"IOM"=2," "=1,"WHO/FAO"=4,"IOM"=2)) %>%
add_header_above(c(" "=3,"Weight (kg) "=9, "Height (cm) "=7)) %>%
column_spec(c(1,3,12,19),border_right = TRUE)%>%
#row_spec(c(3:4,7:8,11:12),background="gray90")%>%
footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")
save_kable(whref_print,"refwtht.png")
print(whref_print)
AE_print<-kable(AE_allref,booktabs=TRUE,caption="Comparison of Adult Equivalents",
col.names=c("Sex","Age Range","Age","WHO/FAO","IOM","WHO/FAO","India","WHO/FAO","IOM","N"),
escape=F)%>%
kable_styling(full_width=FALSE,"striped")%>%
add_header_above(c(" "=3,"Actual Weight/Height"=2,"Age Weight/Height"=1,"Reference Group Weight/Height"=3," "=1)) %>%
add_header_above(c(" "=3,"Adult Equivalents"=6," "=1)) %>%
column_spec(c(1,3,9,10),border_right = TRUE)%>%
#row_spec(c(3:4,7:8,11:12),background="gray90")%>%
footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
Adult Equivalent is equal to individual energy requirements relative to the energy requirements for an 18-30 year old male with moderate activity.
India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2015
WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")
save_kable(AE_print,"AE.png")
print(AE_print)
#task: un-delete graph_allref
rm(allref,w,ref_wtht,a,h,w)
ref=c("India_grp","FAO_grp","IOM_grp","FAO_I","IOM_I","FAO_age")
for (i in 1:length(nutnames)) {
#task: use column names to select columns instead of index
temp=w.I.roster.2015%>%
dplyr::select(hhid,mid,sex,age,BMI,age_range,contains("share"),contains(nutnames[[i]]),hhds,dvcode,vcode,aeu,hhweightR2,popweightR2,BMI_FAO_age)%>%
arrange(hhid)
for (j in ref){
temp[[paste0("I_share_",j,sep="_",nutnames[[i]])]]<-temp[[paste0("hh_",nutnames[[i]])]]*temp[[paste0("share_",j)]]
}
assign(paste(nutnames[[i]],"inadequacy",sep="_"),temp)
}
kcal_inadequacy=kcal_inadequacy%>%
mutate( sex=as.factor(sex),BMI_inadequate_FAO_age=if_else(BMI<BMI_FAO_age,1,0),
BMI_gap_FAO_age=if_else(BMI_inadequate_FAO_age==1,(BMI-BMI_FAO_age)/BMI_FAO_age,as.numeric(NA)))%>%
group_by(hhid)%>%
mutate_at(vars(starts_with("kcal_")), funs(hh_ = "sum"))%>%
ungroup()%>%
mutate_at(.vars=vars(matches("hh_")),.funs=funs("inadequate"=if_else(hh_kcal<.,1,0)))%>%
dplyr::select(-hh_kcal_inadequate)
#ENERGY (kcal/BMI)
for (j in ref){
#actual reported consumption inadequacy
kcal_inadequacy[[paste0("actual_inadequate_",j)]]<-if_else(kcal_inadequacy$I_kcal<kcal_inadequacy[[paste0("kcal",sep="_",j)]],1,0)
kcal_inadequacy[[paste0("actual_gap_",j)]]<-if_else(kcal_inadequacy[[paste0("actual_inadequate_",j)]]==1,(kcal_inadequacy$I_kcal-kcal_inadequacy[[paste0("kcal",sep="_",j)]])/kcal_inadequacy[[paste0("kcal",sep="_",j)]],as.numeric(NA))
kcal_inadequacy[[paste0("actual_Ina.HHok_",j)]]<-if_else(kcal_inadequacy[[paste0("actual_inadequate_",j)]]==1&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==0,1,0)
kcal_inadequacy[[paste0("actual_Iok.HHin_",j)]]<-if_else(kcal_inadequacy[[paste0("actual_inadequate_",j)]]==0&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==1,1,0)
#share allocation inadequacy
kcal_inadequacy[[paste0("share_inadequate_",j)]]<-if_else(kcal_inadequacy[[paste0("I_share_",j,"_kcal")]]<kcal_inadequacy[[paste0("kcal",sep="_",j)]],1,0)
kcal_inadequacy[[paste0("share_gap_",j)]]<-if_else(kcal_inadequacy[[paste0("share_inadequate_",j)]]==1,(kcal_inadequacy[[paste0("I_share_",j,"_kcal")]]-kcal_inadequacy[[paste0("kcal",sep="_",j)]])/kcal_inadequacy[[paste0("kcal",sep="_",j)]],as.numeric(NA))
kcal_inadequacy[[paste0("share_Ina.HHok_",j)]]<-if_else(kcal_inadequacy[[paste0("share_inadequate_",j)]]==1&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==0,1,0)
kcal_inadequacy[[paste0("share_Iok.HHin_",j)]]<-if_else(kcal_inadequacy[[paste0("share_inadequate_",j)]]==0&kcal_inadequacy[[paste0("kcal_",j,"_hh__inadequate")]]==1,1,0)
}
w_kcal=kcal_inadequacy%>%
as_survey_design(ids=vcode, strata=dvcode,weights=popweightR2)%>%
group_by(sex,age_range)%>%
summarise_all(survey_mean,na.rm=TRUE)%>%
dplyr::select(sex,age_range,contains("inadequate"),contains("gap"),contains("HHok"),contains("Iok"),-contains("_se"))
age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
"Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_kcal$age_range<-reorder.factor(w_kcal$age_range,new.order=age)
w_kcal[w_kcal==0]<-as.numeric(NA)
levels(w_kcal$sex)<-list("Male"="1","Female"="2")
graph_kcal_f=w_kcal%>%
arrange(age_range)%>%
dplyr::select(1:2,BMI_inadequate_FAO_age,contains("actual_inadequate"),contains("share_inadequate"))%>%
mutate_at(vars(contains("inadequate")),funs(.*100))%>%
pivot_longer(cols=3:15,names_to=c("variable","sourceref"),names_sep="_inadequate_",values_drop_na = TRUE)
x.label=c("Toddler \n (2-3)","Young Child \n (4-7)","Older Child \n (8-10)","Young Adolescent \n (11-13)","Older Adolescent \n (14-17)",
"Young Adult \n (18-29)","Adult \n (30-59)","Older Adult \n (60+)")
sr=unique(graph_kcal_f$sourceref)
wha=c("India_grp","FAO_age","FAO_grp","IOM_grp","FAO_I","IOM_I") #5 for weight
lbl=c("India (age group)","WHO/FAO (age)","WHO/FAO (age group)","IOM (age group)","WHO/FAO (sample wt/ht)","IOM (sample wt/ht)")
clr=c("green","blue","blue","red","blue","red")
lnt=c("dashed","dotted","dashed","dashed","solid","solid")
kcalf_m=ggplot()+geom_path(data=subset(graph_kcal_f,sex==1),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
scale_y_continuous(name="Energy inadequacy % ",limits=c(0,100),breaks=seq(0,100,10),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(variable)))+theme(legend.position=c(0.5,0.4),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(kcalf_m)
ggsave("kf_plot_m.png")
View(kcalf_m)
View(kcalf_m)
View(graph_kcal_f)
kcalf_m=ggplot()+geom_path(data=subset(graph_kcal_m,sex==1),aes(x=factor(age_range),y=value,group=sourceref,color=sourceref,linetype=sourceref),size=1)+scale_color_manual(breaks=wha,values=clr,name="Reference Source and Level",labels=lbl)+scale_linetype_manual(breaks=wha,values=lnt,labels=lbl,name="Reference Source and Level")+
scale_y_continuous(name="Energy inadequacy % ",limits=c(0,100),breaks=seq(0,100,10),expand=c(0,0))+scale_x_discrete(name="Age Group",breaks=unique(graph_allref$age_range),labels=x.label)+facet_grid(cols=vars(factor(variable)))+theme(legend.position=c(0.5,0.4),legend.background=element_rect(size=0.5,color="black"),panel.background = element_blank(),axis.line = element_line(color="black"))
print(kcalf_m)
ggsave("kf_plot_m.png")
View(graph_kcal_f)
homicides <- readLines("~/Desktop/STAT385/liju2/Notes/homicides.txt")
date_r <- regexec("<dd>[F|f]ound on (.*?)</dd>", homicides)
date_m <- regmatches(homicides, date_r)
dates <- sapply(date_m, function(x) x[2])
dates <- as.Date(dates, "%B %d, %Y")
age_r <- regexec("(<dd>.*, |<br />Age: )(.*?) years old</dd>", homicides)
age_m <- regmatches(homicides, age_r)
ages <- sapply(age_m, function(x) x[3])
Shooting = grepl("Cause: [Ss]hooting", homicides)
selected_homicides = data.frame("Dates" = dates, "Ages" = ages, "Shooting" = Shooting)
length(homicides)
length(age_m)
sum(is.na(age_m))
sum(is.na(ages))
ages
homicides[94]
homicides <- readLines("homicides.txt")
date_r <- regexec("<dd>[F|f]ound on (.*?)</dd>", homicides)
date_m <- regmatches(homicides, date_r)
dates <- sapply(date_m, function(x) x[2])
dates <- as.Date(dates, "%B %d, %Y")
age_r <- regexec("(<dd>.*, |<br />Age: )(.*?) years old</dd>", homicides)
age_m <- regmatches(homicides, age_r)
ages <- sapply(age_m, function(x) x[3])
Shooting = grepl("Cause: [Ss]hooting", homicides)
selected_homicides = data.frame("Dates" = dates, "Ages" = ages, "Shooting" = Shooting)
head(selected_homicides)
