group_by(a01) %>%
dplyr::summarise(p2_03=sum(p2_03,na.rm=TRUE),p2_06=sum(p2_06,na.rm=TRUE)) %>%
mutate(nonfoodexp2_hhwk=(p2_03+p2_06)/52)
#combine all nonfood exp expenditures
nonfoodexp_2011_hh=left_join(nonfoodexp_2011_m,nonfoodexp_2011_y,by="a01") %>%
mutate(nonfoodexp_hhwk=nonfoodexp1_hhwk + nonfoodexp2_hhwk) %>%
dplyr::select(a01,nonfoodexp_hhwk)
#add food expenditures to household roster_2011
roster_2011_hh=left_join(roster_2011_hh,nonfoodexp_2011_hh,by=c("hhid"="a01")) %>%
mutate(nonfoodexp_hhwk_pc=nonfoodexp_hhwk/hhsize,
nonfoodexp_hhwk_AE_OECD=nonfoodexp_hhwk/AE_OECD)%>%
left_join(foodexp_2011_hh,by=c("hhid"="a01")) %>%
mutate(foodpurch_hhwk_pc = foodpurch_hhwk/hhsize,
foodpurch_hhwk_AE_OECD = foodpurch_hhwk/AE_OECD,
foodtot_hhwk_pc = foodtot_hhwk/hhsize,
foodtot_hhwk_AE_OECD = foodtot_hhwk/AE_OECD)%>%
mutate(foodshare=if_else(nonfoodexp_hhwk>0 & foodtot_hhwk>0,foodtot_hhwk/(foodtot_hhwk+nonfoodexp_hhwk),0),
totexp_hhwk=nonfoodexp_hhwk+foodtot_hhwk)
#dplyr::na_if(roster_2011_hh$foodshare,0) #convert zero to NA
rm(nonfoodexp_m_hh,nonfoodexp_y_hh,upazilla,villages,prices,foodexp_2011,foodexp_2011_hh,nonfoodexp_2011_hh,nonfoodexp_2011_m,nonfoodexp_2011_y,missing_exp)
foodsecurity=x3_female_2011%>%
dplyr::rename(hhid=a01,nofood_freq=x3_02,hungrynight_freq=x3_04,hungryday_freq=x3_06)%>%
mutate(nofood=if_else(x3_01==1,1,0),hungrynight=if_else(x3_03==1,1,0),hungryday=if_else(x3_05==1,1,0))%>%
mutate(cereal_days=x3_07_1+x3_07_2+x3_07_4,
tuber_days=x3_07_3,
vegetable_days=x3_07_5,
fruit_days=x3_07_6 ,
meat_days=x3_07_10+x3_07_11,
egg_days=x3_07_8,
seafood_days=x3_07_12 ,
pulse_days=x3_07_7+x3_07_16,
milk_days=x3_07_9,
fat_days=x3_07_13 ,
sugar_days=x3_07_14 ,
misc_days=x3_07_15+x3_07_17)%>%
mutate_at(.vars=vars(contains("days")),.funs=list(~as.numeric(.)))%>%
mutate_at(.vars=vars(contains("days")),.funs=list(~if_else(.>7,7,.)))%>%
mutate_at(.vars=vars(contains("days")),.funs=funs(`1`=if_else(.>0,1,0)))%>%
rename_at(.vars=vars(contains("days")),.funs=funs(sub("_days_1","",.)))%>%
dplyr::select(-contains("x"))%>%
mutate(hhds=rowSums(.[21:32],na.rm=TRUE))%>%
dplyr::select(hhid,hhds,contains("food"),contains("hungry"),-contains("freq"),-contains("seafood"))
# fx=function(x){
#   mutate(temp=if_else(x>0,1,0))
#   dplyr::rename(gsub("_days","",x)==temp)
# }
#add back to HH level roster
roster_2011_hh=left_join(roster_2011_hh,foodsecurity,by="hhid")
rm(foodsecurity)
#breakdown of assistance type (for all households)
# assistance = u_male_2011 %>%
#   filter(u01==1)
#
# assistance_count = aggregate(a01~slno, data=assistance, FUN = length)
# %>%
#   group_by(a01)%>%
#   summarise(u01_hh=n(mid_1)+n(mid_2))
rm(list=ls(pattern="male"))
### SUMMARY of all 6503 households (ie: 15 hh dropped with two spouses)
summary.hh.2011= roster_2011_hh %>%
psych::describe() %>%
as_tibble(rownames="rowname") %>%
dplyr::select(rowname,n,mean,sd)
#print(roster_2011_hh.summary,digits=3)
sample_type = aggregate(hhid~sampletype, data=roster_2011_hh, FUN = length)
#1:FTF Original 1000
#2:FTF Additional 1080
#3:National Representative 4423
#import weights
weights_2011 <- read_dta("C:/Users/lilac2/Box/BIHS Project/Data/Raw Data/bihs_2011_2012/IFPRI_BIHS_R1_expenditure.dta") %>%
dplyr::select(a01,dvcode,vcode,aeu,hhweightR1,popweightR1)
#weights_2015 <- read_dta("C:/Users/lilac2/Box/BIHS Project/Data/Raw Data/bihs_2015/IFPRI_BIHS_R2_exp.dta")
#choose sample type 2 and 3, eliminate poly households
w.hh.roster.2011=left_join(roster_2011_hh,weights_2011,by=c("hhid"="a01"))%>%
filter(sampletype==2 |sampletype==3)
#%>%filter(poly==0&spouseabroad_hh==0)
#choose sample type 2 and 3, eliminate poly households & children under 1 & individuals w/out mealdata
w.I.roster.2011=left_join(roster_2011_I,weights_2011,by=c("hhid"="a01"))%>%
filter(sampletype==2 |sampletype==3)%>%
filter(I_kcal>0 & mealdata>0 &age>=2)%>%
dplyr::select(-poly,-mealdata)
#&poly==0&abroad==2&spouseabroad==0)
design_HH <- svydesign(data=w.hh.roster.2011,id=~vcode, strata=~dvcode,weights=~hhweightR1)
design_I <- svydesign(data=w.I.roster.2011,id=~vcode, strata=~dvcode,weights=~popweightR1)
# summary.w.hh.2011= w.hh.roster.2011 %>%
#   dplyr::select(hhsize,adult,child,totexp_hhwk,foodshare,hhds,contains("head"),contains("spouse"),vcode,dvcode,popweight1)%>%
#     psych::describe() %>%
#   as_tibble(rownames="rowname") %>%
#   dplyr::select(rowname,n,mean,sd)
listx = dplyr::select(w.hh.roster.2011,hhsize,adult,child,totexp_hhwk,foodshare,hhds,contains("head"),contains("spouse"),-contains("abroad"))%>%
mutate_at(.vars=vars(contains("sex")),.funs=list(~recode(.,"2=0")))%>%
mutate(maritalhead=if_else(maritalhead==2,1,0))
#-contains("sex"),-contains("marital"))
a=svymean(listx,design_HH,na.rm=TRUE)
#ab=print(ftable(a),rownames=c("Household Size","Number of Adults","Number of Children"),digits=2)
ab=as.data.table(a,keep.rownames=T)
ab$rownames<-c("Size","Number of Adults","Number of Children","Total Weekly Expenditure (2012 Taka)","Food Share of Total Expenditure","Household Dietary Diversity Score","Age (Years)","Male ","Married ","Literacy ","No Schooling ","Secondary Schooling ","Agricultural Worker ","Body Mass Index (BMI)","Reported Calorie Consumption (kcal)","Age (Years)","Male ","Literacy ","No Schooling ","Secondary Schooling ","Agricultural Worker ","Body Mass Index (BMI)","Reported Calorie Consumption (kcal)")
abc=ab%>%
dplyr::select(rownames,mean,SE)%>%
mutate(mean=if_else(mean<1,paste0(round(mean*100,2),"%"),as.character(round(mean,2))))
setwd("C:/Users/lilac2/Box/BIHS Project/Programs/R/output")
descriptives=kable(abc,booktabs=TRUE,digits=3,
col.names=c("Variable","Weighted Mean","SD"),escape=F)%>%
kable_styling(full_width=FALSE,bootstrap_options = "condensed")%>%
pack_rows("Household",1,6)%>%
pack_rows("Household Head",7,15)%>%
pack_rows("Spouse of Household Head",16,23)%>%
footnote(general="Data are population-weighted means and standard deviations using sample weights provided by IFPRI")
print(descriptives)
save_kable(descriptives,"BIHS Projectdescriptives.png")
#a=qflextable(ab)
#write.table(ab,file="C:/Users/lilac2/Box/BIHS Project/Programs/R/output/descriptives.doc")
rm(listx,ab,a,abc)
#INDIA requirements and AE
#read in adult equivalent from India
AE_India <-read_excel("C:/Users/lilac2/Box/BIHS Project/Data/Clean Data/nutrient standards/GuidelinesIndia_2011.xlsx",sheet="AE_India",range = "A1:D13",col_types =  "numeric")
#join AE
w.I.roster.2011=fuzzy_left_join(w.I.roster.2011,AE_India,
by=c("age"="agemin", "age"="agemax"),
match_fun=list(`>=`, `<=`))%>%
mutate(AE_India_grp=if_else(sex==1,AE_male,if_else(sex==2 & porl==1,1.71,AE_female)))%>%
dplyr::select(-(39:42))
#India Dietary requirements
India_RDA<-read_excel("C:/Users/lilac2/Box/BIHS Project/Data/Clean Data/nutrient standards/GuidelinesIndia_2011.xlsx",sheet="India_RDA",range = "A1:k19",col_names = TRUE)%>%
mutate(sex=if_else(sex=="male",1,2),agemin=as.numeric(agemin),agemax=as.numeric(agemax),
activity=if_else(is.na(activity),"moderate",activity))%>%
dplyr::select(-1)
#join India requirements (all are using ref weight and height, and assume moderate activity for under 18 p66 Inida (2009))
w.I.roster.2011=w.I.roster.2011%>%
mutate(activityI=if_else(age>=18,activity,"moderate"))%>%
fuzzy_left_join(India_RDA,
by=c("sex","activityI"="activity","age"="agemin", "age"="agemax"),
match_fun=list(`==`,`==`,`>=`, `<=`))%>%
dplyr::rename(activity=activity.x,sex=sex.x,weight_India_grp=refwt_India)%>%
mutate(age_grp_India=if_else(!is.na(agemin),paste(as.character(agemin),as.character(agemax),sep="-"),as.character(NA)),
kcal_India_grp=if_else(pregnant==1,kcal_India+350,if_else(lactating==1,kcal_India+560,kcal_India))
,protein_rda_India=if_else(pregnant==1,protein_rda_India+23,if_else(lactating==1,protein_rda_India+16,protein_rda_India)),
#calcium_rda_India=if_else(porl==1,1200,calcium_rda_India),
#iron_rda_India=if_else(porl==1,21,iron_rda_India)
)%>%
dplyr::select(-contains(".y"),-agemin,-agemax,-calcium_rda_India,-iron_rda_India)
rm(list=ls(pattern="India"))
setwd("C:/Users/lilac2/Box/BIHS Project/Data/Clean Data/nutrient standards")
#FAO weight height
hfa_girls_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_girls_25",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
filter(year%in%(2:4))%>%
mutate(h_med=h_P50)
wfa_girls_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_girls_05",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
filter(year%in%(2:4))%>%
mutate(w_med=w_P50)
girls_24=left_join(hfa_girls_24,wfa_girls_24,by=c("sex","year","month"))
hfa_girls_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_girls_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
mutate(h_med=h_P50)
wfa_girls_510 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_girls_510",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
mutate(w_med=w_P50)
bmi_girls_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="bmi_girls_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=2)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("b",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("b_P"))%>%
mutate(b_med=b_P50)
girls_519=left_join(hfa_girls_519,wfa_girls_510,by=c("sex","year","month"))%>%
left_join(bmi_girls_519,by=c("sex","year","month"))%>%
mutate(w_med=if_else(is.na(w_med),b_med*(h_med/100)^2,w_med))
girls=bind_rows(girls_24,girls_519)
girls_19=girls%>%
filter(year==19)%>%
dplyr::select(contains("med"))
women_20=tibble(year=seq(20,120,1),sex=2,h_med=girls_19$h_med,w_med=girls_19$w_med)
FAO_women=bind_rows(girls,women_20)%>%
mutate(w_med=if_else(is.na(w_med)&year<19,b_med*(h_med/100)^2,w_med))%>%
group_by(sex,year)%>%
dplyr::summarise(across(everything(),median,na.rm=TRUE))%>%
dplyr::select(-month)%>%
mutate(pregnant=0,lactating=0)
FAO_women_med=FAO_women%>%
dplyr::select(sex,year,contains("_med"),pregnant,lactating)
for(i in 14:50){
x=FAO_women_med%>%
filter(year==i)%>%
mutate(pregnant=1,b_med=as.numeric(NA),w_med=w_med+13.25)
y=FAO_women_med%>%
filter(year==i)%>%
mutate(lactating=1)
FAO_women_med=rbind(FAO_women_med,x,y)
}
rm(list=ls(pattern="girls"),women_20,x,y)
hfa_boys_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_boys_25",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
filter(year%in%(2:4))%>%
mutate(h_med=h_P50)
wfa_boys_24 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_boys_05",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
filter(year%in%(2:4))%>%
mutate(w_med=w_P50)
boys_24=left_join(hfa_boys_24,wfa_boys_24,by=c("sex","year","month"))
hfa_boys_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="hfa_boys_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("h",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("h_P"))%>%
mutate(h_med=h_P50)
wfa_boys_510 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="wfa_boys_510",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("w",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("w_P"))%>%
mutate(w_med=w_P50)
bmi_boys_519 <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="bmi_boys_519",col_names = TRUE)%>%
mutate(year=floor(Month/12),month=Month-year*12,sex=1)%>%
dplyr::rename_at(.vars=vars(contains("P")),.funs=funs(paste("b",.,sep="_")))%>%
dplyr::select(sex,year,month,contains("b_P"))%>%
mutate(b_med=b_P50)
boys_519=left_join(hfa_boys_519,wfa_boys_510,by=c("sex","year","month"))%>%
left_join(bmi_boys_519,by=c("sex","year","month"))%>%
mutate(w_med=if_else(is.na(w_med),b_med*(h_med/100)^2,w_med))
boys=bind_rows(boys_24,boys_519)
boys_19=boys%>%
filter(year==19)%>%
dplyr::select(contains("med"))
men_20=tibble(year=seq(20,120,1),sex=1,h_med=boys_19$h_med,w_med=boys_19$w_med)
FAO_men=bind_rows(boys,men_20)%>%
mutate(w_med=if_else(is.na(w_med)&year<19,b_med*(h_med/100)^2,w_med))%>%
group_by(sex,year)%>%
dplyr::summarise(across(everything(),median,na.rm=TRUE))%>%
dplyr::select(-month)%>%
mutate(pregnant=0,lactating=0)
FAO_men_med=FAO_men%>%
dplyr::select(sex,year,contains("_med"),pregnant,lactating)
rm(list=ls(pattern="boys"),men_20)
FAO_hwb=bind_rows(FAO_women,FAO_men)
FAO_hwb_med=bind_rows(FAO_women_med,FAO_men_med)%>%
mutate(age_grp_FAO=if_else(year%in%(4:8),"4-8",if_else(year%in%(9:13),"9-13",if_else(year%in%(14:18),"14-18",if_else(year%in%(19:30),"19-30",if_else(year%in%(31:50),"31-50",if_else(year%in%(51:69),"51-69",if_else(year>=70,"70 and over",as.character(year)))))))))%>%
rename(age=year)%>%
group_by(sex,age_grp_FAO)%>%
mutate(h_FAO_grp=median(h_med),w_FAO_grp=median(w_med))%>%
rename(h_FAO=h_med,w_FAO=w_med,b_FAO=b_med)
rm(list=ls(pattern="men"))
#read in energy requirement formulas
FAO_adult <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="Adult_BMRPAL",range = "A1:M37",col_names = TRUE)%>%
dplyr::select(1:6,9:11,13)%>%
mutate(sex=if_else(sex=="Male",1,2))%>%
filter(agemin>=18)
FAO_child <- read_excel("./WHOFAO_requirements_2011.xlsx",sheet="Child_TEEPAL",range = "A1:P97",col_names = TRUE)%>%
mutate(sex=if_else(sex=="Male",1,2))%>%
dplyr::select(1:6,11,13,14,16)
FAO=bind_rows(FAO_adult,FAO_child)
FAO_energy=FAO_hwb_med%>%
fuzzy_left_join(FAO,by=c("sex"="sex","age"="agemin","age"="agemax"),match_fun=list(`==`,`>=`,`<`))%>%
rename(sex=sex.x)%>%
dplyr::select(-sex.y,-agemin,-agemax)%>%
mutate(protein_FAO_age=if_else(pregnant==1,protein_FAO_perkg*w_FAO+14,
if_else(lactating==1,protein_FAO_perkg*w_FAO+15.75,
protein_FAO_perkg*w_FAO)),
kcal_FAO_age=if_else(pregnant==1,multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp)+285,
if_else(lactating==1,multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp)+485,
multiplier*(kc+kc1*w_FAO+kc2*(w_FAO^2)+E_disp))),
kcal_FAO_grp=if_else(pregnant==1,multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp)+285,
if_else(lactating==1,multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp)+485,
multiplier*(kc+kc1*w_FAO_grp+kc2*(w_FAO_grp^2)+E_disp))))%>%
dplyr::rename(weight_FAO_age=w_FAO,height_FAO_age=h_FAO,weight_FAO_grp=w_FAO_grp,height_FAO_grp=h_FAO_grp,BMI_FAO_age=b_FAO)
base_FAO=FAO_energy%>%
filter(age==18,sex==1,activity=="moderate")
base_kcal_FAO=base_FAO$kcal_FAO_age
#join FAO standards with roster
#calculate energy and protein requirements using reference and individual weights, activity adjustments for everyone
w.I.roster.2011=w.I.roster.2011%>%
mutate(sex=as.numeric(sex))%>%
left_join(FAO_energy,by=c("sex","age","activity","pregnant","lactating"))%>%
mutate(kcal_FAO_I=if_else(pregnant==1,multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp)+285,
if_else(lactating==1,multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp)+485,
multiplier*(kc+kc1*weight+kc2*(weight^2)+E_disp))),
AE_FAO_I=kcal_FAO_I/base_kcal_FAO,AE_FAO_age=kcal_FAO_age/base_kcal_FAO,AE_FAO_grp=kcal_FAO_grp/base_kcal_FAO)%>%
dplyr::select(-(kc:multiplier))
rm(list=ls(pattern="FAO"))
library(plyr)
#DRI standards
#energy requirements
IOM_energy <- read_excel("C:/Users/lilac2/Box/BIHS Project/Data/Clean Data/nutrient standards/IOM_requirements.xlsx",sheet="Energy_IOM",range = "A1:R97",col_names = TRUE)%>%
mutate(sex=if_else(sex=="Male",1,2),activity=revalue(PA_level,c("sedentary"="light","low active"="light","active"="moderate","very active"="heavy")),pregnant=if_else(lifestage=="Pregnancy",1,0),lactating=if_else(lifestage=="Lactation",1,0))%>%
dplyr::select(-1,-2,-PA_level,-age_refmean,-EER_eq)%>%
dplyr::rename(agemin=age_lower_yrs,agemax=age_upper_yrs,kcal_IOM_grp=EER_IOM_ref,height_IOM_grp=refht_IOM,weight_IOM_grp=refwt_IOM)%>%
group_by(sex,agemin,agemax,activity,pregnant,lactating)%>%
dplyr::summarise_all(mean)%>%
ungroup()%>%
mutate(agemax=as.numeric(agemax))%>%
mutate(agemax=if_else(is.na(agemax),150,agemax))
#nutrient requirements
IOM_nutrients <- read_excel("C:/Users/lilac2/Box/BIHS Project/Data/Clean Data/nutrient standards/IOM_requirements.xlsx",sheet="Nutrients",range = "A1:T23",col_names = TRUE)%>%
#dplyr::select(-9,-11)%>%
mutate(sex=if_else(sex=="Male",1,2),pregnant=if_else(lifestage=="Pregnancy",1,0),lactating=if_else(lifestage=="Lactation",1,0))%>%
dplyr::rename(agemin=age_lower_yrs,agemax=age_upper_yrs,calcium_rda_IOM=calcium_rda,calcium_ear_IOM=calcium_ear,
iron_rda_IOM=iron_rda,iron_ear_IOM=iron_ear,
carb_IOM_ear=carb_ear,carb_IOM_rda=carb_rda,carb_IOM_lower=carbohydrate_lower,carb_IOM_upper=carbohydrate_upper,
protein_IOM_lower=protein_lower,protein_IOM_upper=protein_upper,protein_rda_IOM=protein_rda,
fat_IOM_lower=lipids_lower,fat_IOM_upper=lipids_upper)%>%
dplyr::select(-lifestage,-refht_IOM,-refwt_IOM)
base_IOM=IOM_energy%>%
filter(agemin==19,sex==1,activity=="moderate")
base_kcal_IOM=base_IOM$kcal_IOM_grp
#join DRI energy standards with roster (calculate individual and reference requirements, everyone has activity adjustments)
w.I.roster.2011=w.I.roster.2011%>%
fuzzy_left_join(IOM_energy,by=c("sex","age"="agemin", "age"="agemax","activity","pregnant","lactating"),match_fun=list(`==`,`>=`, `<=`,`==`,`==`,`==`))%>%
dplyr::rename(sex=sex.x,activity=activity.x,pregnant=pregnant.x,lactating=lactating.x)%>%
mutate(age_grp_IOM=if_else(!is.na(agemin),paste(as.character(agemin),as.character(agemax),sep="-"),as.character(NA)))%>%
mutate(kcal_IOM_I=eer1-(eer2*age)+refPA*((eer3*weight)+(eer4*height/100))+eer5+eer6)%>%
mutate(AE_IOM_grp=kcal_IOM_grp/base_kcal_IOM,AE_IOM_I=kcal_IOM_I/base_kcal_IOM)%>%
dplyr::select(-contains(".y"),-agemin,-agemax,-refPA,-contains("eer"))
#generate individual and reference nutrient standards for IOM
w.I.roster.2011=w.I.roster.2011%>%
fuzzy_left_join(IOM_nutrients,by=c("sex","age"="agemin","age"="agemax","pregnant","lactating"), match_fun=list(`==`,`>=`, `<=`,`==`,`==`))%>%
dplyr::rename(sex=sex.x,pregnant=pregnant.x,lactating=lactating.x)%>%
mutate(protein_ear_IOM_grp=protein_ear_perkg*weight_IOM_grp,protein_ear_IOM_I=protein_ear_perkg*weight)%>%
dplyr::select(-contains(".y"),-protein_ear_perkg,-agemin,-agemax)
xlist=c("protein","carb")
ylist=c("lower","upper")
#zlist=c("grp","I")
for (x in xlist){
for (y in ylist){
# for (z in zlist){
w.I.roster.2011[[paste(x,y,"IOM_grp",sep="_")]]<-  (w.I.roster.2011[[paste(x,"IOM",y,sep="_")]]/100)*w.I.roster.2011[[paste("kcal_IOM_grp",sep="_")]]/4
#}
}
}
xlist=c("fat")
ylist=c("lower","upper")
#zlist=c("grp","I")
for (x in xlist){
for (y in ylist){
# for (z in zlist){
w.I.roster.2011[[paste(x,y,"IOM_grp",sep="_")]]<-  (w.I.roster.2011[[paste(x,"IOM",y,sep="_")]]/100)*w.I.roster.2011[[paste("kcal_IOM_grp",sep="_")]]/9
#}
}
}
w.I.roster.2011=w.I.roster.2011%>%
dplyr::select(-contains("IOM_upper"),-contains("IOM_lower"))
rm(list=ls(pattern="IOM"),x,y,z,xlist,ylist,zlist)
#reference weights and heights
ref_wtht = w.I.roster.2011%>%
dplyr::select(hhid,mid,sex,sampletype,age,contains("age_grp"),pregnant,lactating,contains("weight"),contains("height"),contains("code"),contains("R1"))
#add back HH-level variables and generate three more hh level
hh=w.I.roster.2011%>%
dplyr::select(hhid,contains("AE"),-aeu)%>%
group_by(hhid)%>%
dplyr::summarise_all(sum,na.rm=TRUE)%>%
dplyr::rename_at(.vars=vars(2:7),.funs=funs(sub("AE_","hhsize_",.)))
w.hh.roster.2011=left_join(w.hh.roster.2011,hh,by="hhid")
h=w.hh.roster.2011%>%
dplyr::select(hhid,contains("hhsize_"),contains("hh_"),AE_OECD,hhds,nofood,hungryday,hungrynight)%>%
dplyr::rename(hhsize_OECD=AE_OECD)
w.I.roster.2011=left_join(w.I.roster.2011,h,by="hhid")%>%
mutate(share_India_grp=AE_India_grp/hhsize_India_grp,share_FAO_grp=AE_FAO_grp/hhsize_FAO_grp,share_IOM_grp=AE_IOM_grp/hhsize_IOM_grp,share_FAO_I=AE_FAO_I/hhsize_FAO_I,share_IOM_I=AE_IOM_I/hhsize_IOM_I,share_FAO_age=AE_FAO_age/hhsize_FAO_age,
age_range=if_else(age>=2&age<4,"Toddler (2-3)",
if_else(age>=4&age<8,"Young Child (4-7)",
if_else(age>=8&age<11,"Older Child (8-10)",
if_else(age>=11&age<14,"Young Adolescent (11-13)",
if_else(age>=14&age<18,"Older Adolescent (14-17)",
if_else(age>=18&age<30,"Young Adult (18-29)",
if_else(age>=30&age<=60,"Adult (30-59)",
if_else(age>60,"Older Adult (60+)",as.character(NA))))))))))
rm(h,hh)
# ## SUMMARY TABLES FOR D&T SUBSET
# # "we restrict the sample to households with male, married heads whose spouses are present and to
# # households without pregnant or lactating women. This sample of 3,060 house-holds..." (page 631)
#
# ##DST TABLE 1
# roster_hh_DST = wroster_2011_hh %>%
#   filter(sexhead==1 & maritalhead==2 & abroadhead==0 & poly==0 & porl_hh==0 & spouseabroad_hh==0)
#
# #nrow(filter(roster_hh_DST,is.na(BMIhead))) #86 missing
# #nrow(filter(roster_hh_DST,is.na(BMIspouse))) #45 missing
#
# design_hh_DT <- svydesign(data=roster_hh_DST,id=~vcode, strata=~dvcode,weights=~hhweightR1)
#
# listx = dplyr::select(roster_hh_DST,22,53,63,66,2,19,20,6,7,8,33,37:42,43,46:51)
# a=svymean(listx,design_hh_DT,na.rm=TRUE)
# print(ftable(a),digits=2)
#
# #this is not weighted, use svymean for weighted results
# roster_hh_DST.summary = roster_hh_DST %>%
#   psych::describe() %>%
#   as_tibble(rownames="rowname") %>%
#   dplyr::select(rowname,n,mean,sd)
#
# #print(roster_hh_DST.summary,digits=3)
# #
# # table1= dplyr::bind_cols(roster_2011_hh.summary,roster_hh_DST.summary) %>%
# #   dplyr::select(-rowname1)%>%
# #   dplyr::rename(obs_full=n,mean_full=mean,sd_full=sd,obs_sample=n1,mean_sample=mean1,sd_sample=sd1) %>%
# #   dplyr::filter(rowname=="hhdaycalperAE" |rowname=="hhdayecalperAE" | rowname=="nonfoodexp_hhwkpc" | rowname=="foodpurch_hhwkpc" | rowname=="foodshare" | rowname=="hhsize" | rowname=="AE" | rowname=="boy" | rowname=="girl" | rowname=="otheradult"
# #                 | rowname=="agehead" |rowname=="lithead" |rowname=="noschoolhead" |rowname=="secondschoolhead" |rowname=="agworkhead" |rowname=="BMIhead"
# #                 | rowname=="agespouse" |rowname=="litspouse" |rowname=="noschoolspouse" |rowname=="secondschoolspouse" |rowname=="agworkspouse" |rowname=="BMIspouse")
# #
# #
# # kable(table1,booktabs=TRUE,digits=2,caption="Table 1", col.names=c("Variable","N","Mean","SD","N","Mean","SD"),align='r')%>%
# #   kable_styling(full_width=TRUE)%>%
# #   pack_rows("Household Head",8,13)%>%
# #   pack_rows("Spouse",14,19)%>%
# #   pack_rows("Expenditures",20,22)%>%
# #   add_header_above(c(" "=1,"All Households"=3,"D&T Sample"=3))
# #
#
# ###TABLE 3
# roster_I_DST=wroster_2011_I%>%
#   filter(sexhead==1 & maritalhead==2 & abroadhead==0 & poly==0 & porl_hh==0 & spouseabroad_hh==0)%>%
#   mutate(BMIunder=if_else(BMI<18.5,(18.5-BMI)/18.5,0),
#          adultgrp=if_else(relation==1,"head",if_else(relation==2,"spouse",if_else(otheradult==1,"otheradult",as.character(NA)))))%>%
#    filter(!is.na(agegrp_DST),!is.na(BMI),!is.na(adultgrp))%>%
#   dplyr::select(hhid,mid,agegrp_DST,adultgrp,BMI,BMIunder,vcode,dvcode,popweightR1)
#
# #%>%
#  # reshape2::cast(agegrp~adultgrp,fun.aggregate=c(mean,sd,n))
#
# #roster_I_DST$DST[is.na(roster_I_DST$DST)]<-0 #convert zero to NA
# design_I_DT <- svydesign(data=roster_I_DST,id=~vcode, strata=~dvcode,weights=~popweightR1)
#
# table3= roster_I_DST %>%
#   group_by(agegrp_DST,adultgrp) %>%
#   summarise(mean=mean(BMIunder),se=sd(BMIunder)/sqrt(length(BMIunder)),n=n())%>%
#   reshape2::melt(id.vars=c("agegrp_DST","adultgrp"),measure.var=c("mean","se","n"))%>%
#   dplyr::arrange(agegrp_DST)%>%
#   unite(agegrp_DST,variable,col="agegrp_DST_var",sep="_")%>%
#   dcast(agegrp_DST_var~adultgrp,value.var = "value")%>%
#   separate(agegrp_DST_var,into=c("agegrp_DST","var"),"_")%>%
#   dplyr::select(var,head,spouse,otheradult)
# #
# #
# # kable(table3,booktabs=TRUE,digits=3,caption="Table 3: BMI Shortfalls", col.names=c("","Heads","Spouses","Other Adults"),align='r')%>%
# #   kable_styling(full_width=TRUE)%>%
# #   pack_rows("Ages 20-39",1,3)%>%
# #   pack_rows("Ages 40-59",4,6)%>%
# #   pack_rows("Ages 60 and up",7,9)
#
# #%>%
#  # add_header_above(c(" "=1,"All Households"=3,"D&T Sample"=3))
options(digits=3,knitr.kable.NA = '')
setwd("C:/Users/lilac2/Box/BIHS Project/Programs/R/output")
#compare reference weights by age group
allref=w.I.roster.2011%>%
mutate(weight_India_grp_b=if_else(weight<weight_India_grp,1,0),
weight_FAO_grp_b=if_else(weight<weight_FAO_grp,1,0),
weight_FAO_age_b=if_else(weight<weight_FAO_age,1,0),
weight_IOM_grp_b=if_else(weight<weight_IOM_grp,1,0),
height_FAO_grp_b=if_else(height<height_FAO_grp,1,0),
height_FAO_age_b=if_else(height<height_FAO_age,1,0),
height_IOM_grp_b=if_else(height<height_IOM_grp,1,0))%>%
dplyr::select(hhid,mid,age,age_range,sex,contains("weight"),contains("height"),contains("AE_"),contains("code"),contains("R1"))
w_allref=allref%>%
as_survey_design(ids=vcode, strata=dvcode,weights=popweightR1)%>%
group_by(sex,age_range)%>%
summarise_all(survey_mean,na.rm=TRUE)%>%
dplyr::select(-contains("code"),-contains("R1"),-contains("hhid"),-contains("mid"),-contains("_se"))
w=allref%>%
group_by(sex,age_range)%>%
dplyr::summarise(n=n())
w_allref=left_join(w_allref,w,by=c("sex","age_range"))
age=c("Toddler (2-3)","Young Child (4-7)","Older Child (8-10)","Young Adolescent (11-13)","Older Adolescent (14-17)",
"Young Adult (18-29)","Adult (30-59)","Older Adult (60+)")
w_allref$age_range<-reorder.factor(w_allref$age_range,new.order=age)
w_allref=w_allref%>%
arrange(age_range)%>%
mutate_at(vars(contains("_b")),funs(scales::percent(.,accuracy=.01)))
#%>%mutate(across(is.numeric, round, 4))
wh_allref=w_allref%>%
dplyr::select(sex,age_range,age,weight,contains("weight_India_grp"),contains("weight_FAO_age"),contains("weight_FAO_grp"),contains("weight_IOM_grp"),height,contains("height_FAO_age"),contains("height_FAO_grp"))
AE_allref=w_allref%>%
dplyr::select(sex,age_range,age,AE_FAO_I,AE_IOM_I,AE_FAO_age,AE_India_grp,AE_FAO_grp,AE_IOM_grp,n)
#w_allref[w_allref==0]<-as.numeric(NA)
#w_allref[is.na(w_allref)]<-""
whref_print<-kable(wh_allref,booktabs=TRUE,caption="Comparison of Reference Standards for Weight and Height",
col.names=c("Sex","Age Range","Age","Sample","Reference Group","% Below","Reference Age","% Below","Reference Group","% Below","Reference Group","% Below","Sample","Reference Group","% Below","Reference Group","% Below"),
escape=F)%>%
kable_styling(full_width=FALSE,"striped")%>%
add_header_above(c(" "=3," "=1,"India"=2, "WHO/FAO"=4,"IOM"=2," "=1,"WHO/FAO"=2,"IOM"=2)) %>%
add_header_above(c(" "=3,"Weight (kg) "=9, "Height (cm) "=5)) %>%
column_spec(c(1,3,12,17),border_right = TRUE)%>%
#row_spec(c(3:4,7:8,11:12),background="gray90")%>%
footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2011
WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")
save_kable(whref_print,"refwtht.png")
print(whref_print)
AE_print<-kable(AE_allref,booktabs=TRUE,caption="Comparison of Adult Equivalents",
col.names=c("Sex","Age Range","Age","WHO/FAO","IOM","WHO/FAO","India","WHO/FAO","IOM","N"),
escape=F)%>%
kable_styling(full_width=FALSE,"striped")%>%
add_header_above(c(" "=3,"Actual Weight/Height"=2,"Age Weight/Height"=1,"Reference Group Weight/Height"=3," "=1)) %>%
add_header_above(c(" "=3,"Adult Equivalents"=6," "=1)) %>%
column_spec(c(1,3,9,10),border_right = TRUE)%>%
#row_spec(c(3:4,7:8,11:12),background="gray90")%>%
footnote(general="Data are population-weighted means using sample weights provided by IFPRI.
Adult Equivalent is equal to individual energy requirements relative to the energy requirements for an 18-30 year old male with moderate activity.
India refers to the Dietary Guidelines for India published by the National Institute of Nutrition in 2011
WHO/FAO refers to the Human Energy Requirements published by WHO/FAO in 2001
IOM refrs to the Dietary Reference Intakes published by the Institute of Medicine in 2005")
save_kable(AE_print,"AE.png")
print(AE_print)
rm(allref,w,ref_wtht)
